{"version":3,"file":"index-DhXOalGt.js","sources":["../../src/data/models/utils.ts","../../src/application/use-cases/ParseDSLUseCase.ts","../../src/application/use-cases/RenderDiagramUseCase.ts","../../src/application/use-cases/ExportCodeUseCase.ts","../../src/application/services/DiagramService.ts","../../src/domain/entities/Entity.ts","../../src/domain/entities/Field.ts","../../src/domain/entities/Relationship.ts","../../src/infrastructure/parsers/DSLParserAdapter.ts","../../src/domain/value-objects/Position.ts","../../src/infrastructure/layout/ConnectionBasedLayoutEngine.ts","../../src/infrastructure/layout/LayoutPositioner.ts","../../src/infrastructure/layout/FieldOrderingAlgorithm.ts","../../src/infrastructure/layout/MagneticAlignmentOptimizer.ts","../../src/infrastructure/renderers/CanvasRendererAdapter.ts","../../src/infrastructure/exporters/SQLExporter.ts","../../src/infrastructure/exporters/TypeScriptExporter.ts","../../src/infrastructure/exporters/JSONExporter.ts","../../src/presentation/controllers/AppController.ts","../../src/presentation/factories/MonacoEditorFactory.ts","../../src/main.ts"],"sourcesContent":["/**\n * Utility functions for working with domain entities\n *\n * These functions provide business logic operations without requiring\n * entity instances to be converted to model instances\n */\n\nimport { Entity } from '../../domain/entities/Entity';\nimport { Field } from '../../domain/entities/Field';\nimport { Relationship, RelationshipType } from '../../domain/entities/Relationship';\n\n/**\n * Get cardinality notation for a relationship\n */\nexport function getRelationshipCardinality(relationship: Relationship): string {\n    const cardinalityMap: Record<RelationshipType, string> = {\n        'one-to-one': '1:1',\n        'one-to-many': '1:N',\n        'many-to-one': 'N:1',\n        'many-to-many': 'N:N'\n    };\n    return cardinalityMap[relationship.type] || relationship.type;\n}\n\n/**\n * Validate a field\n */\nexport function validateField(field: Field): { isValid: boolean; error?: string } {\n    if (!field.name || field.name.trim().length === 0) {\n        return { isValid: false, error: 'Field name is required' };\n    }\n\n    if (!field.type || field.type.trim().length === 0) {\n        return { isValid: false, error: 'Field type is required' };\n    }\n\n    return { isValid: true };\n}\n\n/**\n * Validate a relationship\n */\nexport function validateRelationship(relationship: Relationship): { isValid: boolean; error?: string } {\n    if (!relationship.from || !relationship.from.entity || !relationship.from.field) {\n        return { isValid: false, error: 'Relationship source is incomplete' };\n    }\n\n    if (!relationship.to || !relationship.to.entity || !relationship.to.field) {\n        return { isValid: false, error: 'Relationship target is incomplete' };\n    }\n\n    return { isValid: true };\n}\n\n/**\n * Validate an entity\n */\nexport function validateEntity(entity: Entity): { isValid: boolean; error?: string } {\n    if (!entity.name || entity.name.trim().length === 0) {\n        return { isValid: false, error: 'Entity name is required' };\n    }\n\n    if (entity.fields.length === 0) {\n        return { isValid: false, error: `Entity \"${entity.name}\" has no fields` };\n    }\n\n    for (const field of entity.fields) {\n        const fieldValidation = validateField(field);\n        if (!fieldValidation.isValid) {\n            return {\n                isValid: false,\n                error: `Entity \"${entity.name}\": ${fieldValidation.error}`\n            };\n        }\n    }\n\n    return { isValid: true };\n}\n\n/**\n * Get the primary key field of an entity\n */\nexport function getEntityPrimaryKey(entity: Entity): Field | undefined {\n    return entity.fields.find(f => f.isPrimaryKey);\n}\n\n/**\n * Get the foreign key fields of an entity\n */\nexport function getEntityForeignKeys(entity: Entity): Field[] {\n    return entity.fields.filter(f => f.isForeignKey);\n}\n\n/**\n * Get a field by name from an entity\n */\nexport function getEntityField(entity: Entity, fieldName: string): Field | undefined {\n    return entity.fields.find(f => f.name === fieldName);\n}\n\n/**\n * Reorder fields in an entity based on a new order array\n * @param entity The entity to reorder fields in\n * @param newOrder Array of field names in desired order\n */\nexport function reorderEntityFields(entity: Entity, newOrder: string[]): void {\n    const orderedFields: Field[] = [];\n    const fieldMap = new Map(entity.fields.map(f => [f.name, f]));\n\n    // Add fields in the specified order\n    for (const fieldName of newOrder) {\n        const field = fieldMap.get(fieldName);\n        if (field) {\n            orderedFields.push(field);\n            fieldMap.delete(fieldName);\n        }\n    }\n\n    // Add any remaining fields that weren't in newOrder\n    for (const field of fieldMap.values()) {\n        orderedFields.push(field);\n    }\n\n    entity.fields = orderedFields;\n}\n\n/**\n * Add a field to an entity\n */\nexport function addFieldToEntity(entity: Entity, field: Field): void {\n    entity.fields.push(field);\n}\n\n/**\n * Convert a field to JSON\n */\nexport function fieldToJSON(field: Field): Record<string, any> {\n    return {\n        name: field.name,\n        displayName: field.displayName,\n        type: field.type,\n        isPrimaryKey: field.isPrimaryKey,\n        isForeignKey: field.isForeignKey,\n        isUnique: field.isUnique,\n        isRequired: field.isRequired,\n        defaultValue: field.defaultValue,\n        enumValues: field.enumValues,\n        decorators: field.decorators\n    };\n}\n\n/**\n * Convert a relationship to JSON\n */\nexport function relationshipToJSON(relationship: Relationship): Record<string, any> {\n    return {\n        from: relationship.from,\n        to: relationship.to,\n        type: relationship.type,\n        color: relationship.color,\n        label: relationship.label\n    };\n}\n\n/**\n * Convert an entity to JSON\n */\nexport function entityToJSON(entity: Entity): Record<string, any> {\n    return {\n        name: entity.name,\n        displayName: entity.displayName,\n        icon: entity.icon,\n        color: entity.color,\n        fields: entity.fields.map(fieldToJSON)\n    };\n}\n","/**\r\n * Use Case: Parse DSL\r\n *\r\n * Parses DSL text into domain entities and relationships\r\n */\r\nimport { IDiagramRepository, ParseError } from '../../domain/repositories/IDiagramRepository';\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { validateEntity, validateRelationship } from '../../data/models/utils';\r\n\r\nexport interface ParseDSLResult {\r\n  entities: Entity[];\r\n  relationships: Relationship[];\r\n  errors: ParseError[];\r\n  isValid: boolean;\r\n}\r\n\r\nexport class ParseDSLUseCase {\r\n  constructor(private diagramRepository: IDiagramRepository) {}\r\n\r\n  async execute(dslText: string): Promise<ParseDSLResult> {\r\n    if (!dslText || dslText.trim() === '') {\r\n      return {\r\n        entities: [],\r\n        relationships: [],\r\n        errors: [{ message: 'DSL text is empty', line: 0 }],\r\n        isValid: false\r\n      };\r\n    }\r\n\r\n    try {\r\n      const result = await this.diagramRepository.parseDSL(dslText);\r\n\r\n      // Validate all entities\r\n      const entityErrors: ParseError[] = [];\r\n      for (const entity of result.entities) {\r\n        const validation = validateEntity(entity);\r\n        if (!validation.isValid) {\r\n          entityErrors.push({\r\n            message: `Entity '${entity.name}': ${validation.error}`,\r\n            line: 0\r\n          });\r\n        }\r\n      }\r\n\r\n      // Validate all relationships\r\n      const relationErrors: ParseError[] = [];\r\n      for (const relationship of result.relationships) {\r\n        const validation = validateRelationship(relationship);\r\n        if (!validation.isValid) {\r\n          relationErrors.push({\r\n            message: `Relationship: ${validation.error}`,\r\n            line: 0\r\n          });\r\n        }\r\n      }\r\n\r\n      const allErrors = [...result.errors, ...entityErrors, ...relationErrors];\r\n\r\n      return {\r\n        entities: result.entities,\r\n        relationships: result.relationships,\r\n        errors: allErrors,\r\n        isValid: allErrors.length === 0\r\n      };\r\n    } catch (error) {\r\n      return {\r\n        entities: [],\r\n        relationships: [],\r\n        errors: [{ message: error instanceof Error ? error.message : 'Unknown error', line: 0 }],\r\n        isValid: false\r\n      };\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Use Case: Render Diagram\r\n *\r\n * Renders the diagram using the provided renderer\r\n */\r\nimport { IRenderer } from '../../domain/repositories/IRenderer';\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\nexport class RenderDiagramUseCase {\r\n  constructor(private renderer: IRenderer) {}\r\n\r\n  execute(entities: Entity[], relationships: Relationship[]): void {\r\n    if (!entities || !Array.isArray(entities)) {\r\n      throw new Error('Entities must be an array');\r\n    }\r\n\r\n    if (!relationships || !Array.isArray(relationships)) {\r\n      throw new Error('Relationships must be an array');\r\n    }\r\n\r\n    this.renderer.setData(entities, relationships);\r\n    this.renderer.render();\r\n  }\r\n\r\n  zoomIn(): void {\r\n    this.renderer.zoomIn();\r\n  }\r\n\r\n  zoomOut(): void {\r\n    this.renderer.zoomOut();\r\n  }\r\n\r\n  fitToScreen(): void {\r\n    this.renderer.fitToScreen();\r\n  }\r\n\r\n  autoLayout(): void {\r\n    this.renderer.autoLayout();\r\n  }\r\n\r\n  getZoomLevel(): number {\r\n    return this.renderer.getZoomLevel();\r\n  }\r\n}\r\n","/**\r\n * Use Case: Export Code\r\n *\r\n * Exports entities and relationships to various formats\r\n */\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\nexport interface IExporter {\r\n  export(entities: Entity[], relationships: Relationship[]): string;\r\n}\r\n\r\nexport class ExportCodeUseCase {\r\n  constructor(private exporters: Record<string, IExporter>) {}\r\n\r\n  execute(format: string, entities: Entity[], relationships: Relationship[]): string {\r\n    const exporter = this.exporters[format];\r\n\r\n    if (!exporter) {\r\n      throw new Error(`Unsupported export format: ${format}`);\r\n    }\r\n\r\n    return exporter.export(entities, relationships);\r\n  }\r\n\r\n  getSupportedFormats(): string[] {\r\n    return Object.keys(this.exporters);\r\n  }\r\n}\r\n","/**\r\n * Application Service: DiagramService\r\n *\r\n * Orchestrates use cases for diagram operations\r\n */\r\nimport { ParseDSLUseCase, ParseDSLResult } from '../use-cases/ParseDSLUseCase';\r\nimport { RenderDiagramUseCase } from '../use-cases/RenderDiagramUseCase';\r\nimport { ExportCodeUseCase } from '../use-cases/ExportCodeUseCase';\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\nexport class DiagramService {\r\n  private currentEntities: Entity[] = [];\r\n  private currentRelationships: Relationship[] = [];\r\n\r\n  constructor(\r\n    private parseDSLUseCase: ParseDSLUseCase,\r\n    private renderDiagramUseCase: RenderDiagramUseCase,\r\n    private exportCodeUseCase: ExportCodeUseCase\r\n  ) {}\r\n\r\n  async parseDSL(dslText: string): Promise<ParseDSLResult> {\r\n    const result = await this.parseDSLUseCase.execute(dslText);\r\n\r\n    if (result.isValid) {\r\n      this.currentEntities = result.entities;\r\n      this.currentRelationships = result.relationships;\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  renderDiagram(): void {\r\n    this.renderDiagramUseCase.execute(this.currentEntities, this.currentRelationships);\r\n  }\r\n\r\n  zoomIn(): void {\r\n    this.renderDiagramUseCase.zoomIn();\r\n  }\r\n\r\n  zoomOut(): void {\r\n    this.renderDiagramUseCase.zoomOut();\r\n  }\r\n\r\n  fitToScreen(): void {\r\n    this.renderDiagramUseCase.fitToScreen();\r\n  }\r\n\r\n  autoLayout(): void {\r\n    this.renderDiagramUseCase.autoLayout();\r\n  }\r\n\r\n  getZoomLevel(): number {\r\n    return this.renderDiagramUseCase.getZoomLevel();\r\n  }\r\n\r\n  exportCode(format: string): string {\r\n    return this.exportCodeUseCase.execute(format, this.currentEntities, this.currentRelationships);\r\n  }\r\n\r\n  getSupportedExportFormats(): string[] {\r\n    return this.exportCodeUseCase.getSupportedFormats();\r\n  }\r\n\r\n  getCurrentData(): { entities: Entity[]; relationships: Relationship[] } {\r\n    return {\r\n      entities: this.currentEntities,\r\n      relationships: this.currentRelationships\r\n    };\r\n  }\r\n}\r\n","/**\r\n * Domain Entity: Entity\r\n *\r\n * Represents a database table/entity in the diagram\r\n */\r\n\r\nimport { Field } from './Field';\r\n\r\nexport interface EntityProps {\r\n    name: string;\r\n    displayName: string;\r\n    icon?: string;\r\n    color?: string;\r\n    fields?: Field[];\r\n}\r\n\r\nexport class Entity {\r\n    public readonly name: string;\r\n    public readonly displayName: string;\r\n    public readonly icon: string;\r\n    public readonly color: string;\r\n    public fields: Field[];\r\n\r\n    constructor(props: EntityProps) {\r\n        this.name = props.name;\r\n        this.displayName = props.displayName;\r\n        this.icon = props.icon ?? 'box';\r\n        this.color = props.color ?? '#3b82f6';\r\n        this.fields = props.fields ?? [];\r\n    }\r\n}\r\n","/**\r\n * Domain Entity: Field\r\n *\r\n * Represents a field/column in an entity\r\n */\r\n\r\nexport interface FieldDecorator {\r\n    name: string;\r\n    args?: string | null;\r\n    params?: Record<string, any>;\r\n}\r\n\r\nexport interface FieldProps {\r\n    name: string;\r\n    displayName: string;\r\n    type: string;\r\n    isPrimaryKey?: boolean;\r\n    isForeignKey?: boolean;\r\n    isUnique?: boolean;\r\n    isRequired?: boolean;\r\n    defaultValue?: string | null;\r\n    enumValues?: string[] | null;\r\n    decorators?: FieldDecorator[];\r\n}\r\n\r\nexport class Field {\r\n    public readonly name: string;\r\n    public readonly displayName: string;\r\n    public readonly type: string;\r\n    public readonly isPrimaryKey: boolean;\r\n    public readonly isForeignKey: boolean;\r\n    public readonly isUnique: boolean;\r\n    public readonly isRequired: boolean;\r\n    public readonly defaultValue: string | null;\r\n    public readonly enumValues: string[] | null;\r\n    public readonly decorators: FieldDecorator[];\r\n\r\n    constructor(props: FieldProps) {\r\n        this.name = props.name;\r\n        this.displayName = props.displayName;\r\n        this.type = props.type;\r\n        this.isPrimaryKey = props.isPrimaryKey ?? false;\r\n        this.isForeignKey = props.isForeignKey ?? false;\r\n        this.isUnique = props.isUnique ?? false;\r\n        this.isRequired = props.isRequired ?? false;\r\n        this.defaultValue = props.defaultValue ?? null;\r\n        this.enumValues = props.enumValues ?? null;\r\n        this.decorators = props.decorators ?? [];\r\n    }\r\n}\r\n","/**\r\n * Domain Entity: Relationship\r\n *\r\n * Represents a relationship between two entities\r\n */\r\n\r\nexport type RelationshipType = 'one-to-one' | 'one-to-many' | 'many-to-one' | 'many-to-many';\r\n\r\nexport interface RelationshipEndpoint {\r\n    entity: string;\r\n    field: string;\r\n}\r\n\r\nexport interface RelationshipProps {\r\n    from: RelationshipEndpoint;\r\n    to: RelationshipEndpoint;\r\n    type?: RelationshipType;\r\n    color?: string;\r\n    label?: string;\r\n}\r\n\r\nexport class Relationship {\r\n    public readonly from: RelationshipEndpoint;\r\n    public readonly to: RelationshipEndpoint;\r\n    public readonly type: RelationshipType;\r\n    public readonly color?: string;\r\n    public readonly label?: string;\r\n\r\n    constructor(props: RelationshipProps) {\r\n        this.from = props.from;\r\n        this.to = props.to;\r\n        this.type = props.type ?? 'many-to-one';\r\n        this.color = props.color;\r\n        this.label = props.label;\r\n    }\r\n}\r\n","/**\r\n * Infrastructure Adapter: DSL Parser\r\n *\r\n * Adapts the DSL parser to implement IDiagramRepository\r\n */\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Field } from '../../domain/entities/Field';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { IDiagramRepository, ParseDSLResult, ParseError } from '../../domain/repositories/IDiagramRepository';\r\nimport { addFieldToEntity } from '../../data/models/utils';\r\n\r\ninterface Metadata {\r\n  [key: string]: string;\r\n}\r\n\r\ninterface Decorator {\r\n  name: string;\r\n  args: string | null;\r\n  params: { [key: string]: string | string[] };\r\n}\r\n\r\nexport class DSLParserAdapter implements IDiagramRepository {\r\n  async parseDSL(dslText: string): Promise<ParseDSLResult> {\r\n    const entities: Entity[] = [];\r\n    const relationships: Relationship[] = [];\r\n    const errors: ParseError[] = [];\r\n\r\n    try {\r\n      // Remove comments and split into lines\r\n      const lines = dslText\r\n        .split('\\n')\r\n        .map(line => {\r\n          const commentIndex = line.indexOf('//');\r\n          return commentIndex >= 0 ? line.substring(0, commentIndex) : line;\r\n        })\r\n        .map(line => line.trim())\r\n        .filter(line => line.length > 0);\r\n\r\n      let currentEntity: Entity | null = null;\r\n\r\n      for (let i = 0; i < lines.length; i++) {\r\n        const line = lines[i];\r\n\r\n        // Parse entity declaration\r\n        if (line.includes('{') && !line.startsWith('}')) {\r\n          const entityMatch = line.match(/^(\\w+)\\s*(\\[([^\\]]+)\\])?\\s*\\{/);\r\n          if (entityMatch) {\r\n            const entityName = entityMatch[1];\r\n            const metadataStr = entityMatch[3] || '';\r\n            const metadata = this._parseMetadata(metadataStr);\r\n\r\n            currentEntity = new Entity({\r\n              name: entityName,\r\n              displayName: this._toDisplayName(entityName),\r\n              icon: metadata.icon || 'box',\r\n              color: metadata.color || '#3b82f6',\r\n              fields: []\r\n            });\r\n          }\r\n        }\r\n        // Parse entity closing brace\r\n        else if (line.startsWith('}')) {\r\n          if (currentEntity) {\r\n            entities.push(currentEntity);\r\n            currentEntity = null;\r\n          }\r\n        }\r\n        // Parse relationship (check for relationship operators: >, <, -, <>)\r\n        else if (this._isRelationshipLine(line)) {\r\n          const relationship = this._parseRelationship(line);\r\n          if (relationship) {\r\n            relationships.push(relationship);\r\n          }\r\n        }\r\n        // Parse field\r\n        else if (currentEntity) {\r\n          const field = this._parseField(line);\r\n          if (field) {\r\n            addFieldToEntity(currentEntity, field);\r\n          }\r\n        }\r\n      }\r\n\r\n    } catch (error) {\r\n      errors.push({\r\n        message: error instanceof Error ? error.message : 'Unknown error',\r\n        line: 0\r\n      });\r\n    }\r\n\r\n    return {\r\n      entities,\r\n      relationships,\r\n      errors\r\n    };\r\n  }\r\n\r\n  async saveDiagram(data: unknown): Promise<void> {\r\n    // Could implement local storage or file save\r\n    console.log('Saving diagram:', data);\r\n  }\r\n\r\n  async loadDiagram(): Promise<unknown> {\r\n    // Could implement local storage or file load\r\n    return null;\r\n  }\r\n\r\n  private _parseMetadata(metadataStr: string): Metadata {\r\n    const metadata: Metadata = {};\r\n    if (!metadataStr) return metadata;\r\n\r\n    const pairs = metadataStr.split(',');\r\n    for (const pair of pairs) {\r\n      const [key, value] = pair.split(':').map(s => s.trim());\r\n      if (key && value) {\r\n        metadata[key] = value;\r\n      }\r\n    }\r\n\r\n    return metadata;\r\n  }\r\n\r\n  private _parseField(line: string): Field | null {\r\n    const match = line.match(/^(\\w+)\\s+(\\w+)(.*)$/);\r\n    if (!match) return null;\r\n\r\n    const fieldName = match[1];\r\n    const fieldType = match[2];\r\n    const decoratorsStr = match[3] || '';\r\n\r\n    const decorators = this._parseDecorators(decoratorsStr);\r\n\r\n    const isPrimaryKey = decorators.some(d => d.name === 'pk');\r\n    const isForeignKey = decorators.some(d => d.name === 'fk');\r\n    const isUnique = decorators.some(d => d.name === 'unique');\r\n    const isRequired = decorators.some(d => d.name === 'required') || isPrimaryKey;\r\n\r\n    const defaultDecorator = decorators.find(d => d.name === 'default');\r\n    const defaultValue = defaultDecorator ? defaultDecorator.args : null;\r\n\r\n    const enumDecorator = decorators.find(d => d.name === 'enum');\r\n    const enumValues = enumDecorator && enumDecorator.params && enumDecorator.params.fields\r\n      ? (Array.isArray(enumDecorator.params.fields) ? enumDecorator.params.fields : [enumDecorator.params.fields])\r\n      : null;\r\n\r\n    return new Field({\r\n      name: fieldName,\r\n      displayName: this._toDisplayName(fieldName),\r\n      type: fieldType,\r\n      isPrimaryKey,\r\n      isForeignKey,\r\n      isUnique,\r\n      isRequired,\r\n      defaultValue,\r\n      enumValues,\r\n      decorators\r\n    });\r\n  }\r\n\r\n  private _parseDecorators(decoratorsStr: string): Decorator[] {\r\n    const decorators: Decorator[] = [];\r\n    if (!decoratorsStr) return decorators;\r\n\r\n    const regex = /@(\\w+)(?:\\(([^)]+)\\))?/g;\r\n    let match: RegExpExecArray | null;\r\n\r\n    while ((match = regex.exec(decoratorsStr)) !== null) {\r\n      const name = match[1];\r\n      const argsStr = match[2];\r\n\r\n      let args: string | null = null;\r\n      const params: { [key: string]: string | string[] } = {};\r\n\r\n      if (argsStr) {\r\n        if (argsStr.includes(':')) {\r\n          const pairs = argsStr.split(',');\r\n          for (const pair of pairs) {\r\n            const [key, value] = pair.split(':').map(s => s.trim());\r\n            if (key && value) {\r\n              if (value.startsWith('[') && value.endsWith(']')) {\r\n                params[key] = value\r\n                  .substring(1, value.length - 1)\r\n                  .split(',')\r\n                  .map(v => v.trim());\r\n              } else {\r\n                params[key] = value;\r\n              }\r\n            }\r\n          }\r\n        } else {\r\n          args = argsStr.trim();\r\n        }\r\n      }\r\n\r\n      decorators.push({ name, args, params });\r\n    }\r\n\r\n    return decorators;\r\n  }\r\n\r\n  private _isRelationshipLine(line: string): boolean {\r\n    // Check if line contains relationship operators\r\n    return /(\\w+)\\.?(\\w+)?\\s*([<>-]|<>)\\s*(\\w+)\\.?(\\w+)?/.test(line);\r\n  }\r\n\r\n  private _parseRelationship(line: string): Relationship | null {\r\n    // Parse relationship with various syntaxes:\r\n    // users.teamId > teams.id  (one-to-many)\r\n    // users.teamId < teams.id  (many-to-one)\r\n    // users.id - teams.id      (one-to-one)\r\n    // users.id <> teams.id     (many-to-many)\r\n    // users > teams            (entity-level, one-to-many)\r\n    // Support for metadata: users.teamId > teams.id [color: green]\r\n\r\n    const relationshipRegex = /^(\\w+)\\.?(\\w+)?\\s*([<>-]|<>)\\s*(\\w+)\\.?(\\w+)?\\s*(?:\\[([^\\]]+)\\])?$/;\r\n    const match = line.match(relationshipRegex);\r\n\r\n    if (!match) return null;\r\n\r\n    let fromEntity = match[1];\r\n    let fromField = match[2] || 'id';\r\n    const connector = match[3];\r\n    let toEntity = match[4];\r\n    let toField = match[5] || 'id';\r\n    const metadataStr = match[6] || '';\r\n\r\n    // Determine relationship type based on connector\r\n    let type: 'one-to-one' | 'one-to-many' | 'many-to-one' | 'many-to-many';\r\n    switch (connector) {\r\n      case '<':\r\n        type = 'one-to-many';\r\n        break;\r\n      case '>':\r\n        type = 'many-to-one';\r\n        break;\r\n      case '-':\r\n        type = 'one-to-one';\r\n        break;\r\n      case '<>':\r\n        type = 'many-to-many';\r\n        break;\r\n      default:\r\n        type = 'many-to-one';\r\n    }\r\n\r\n    // // IMPORTANT: Don't swap\r\n    // // \"A.x > B.y\" means \"A.x references B.y\" (A depends on B)\r\n    // // But \"A.id > B.x\" means \"A.id is referenced by B.x\" (B depends on A)\r\n    // // We need to swap direction when the left side is an 'id' field being referenced\r\n    // if (fromField === 'id' && toField !== 'id' && (connector === '>' || connector === '<')) {\r\n    //   // Swap from and to\r\n    //   [fromEntity, toEntity] = [toEntity, fromEntity];\r\n    //   [fromField, toField] = [toField, fromField];\r\n\r\n    //   // Also flip the type\r\n    //   if (type === 'many-to-one') type = 'one-to-many';\r\n    //   else if (type === 'one-to-many') type = 'many-to-one';\r\n    // }\r\n\r\n    // Parse metadata (color, label, etc.)\r\n    const metadata = this._parseMetadata(metadataStr);\r\n\r\n    return new Relationship({\r\n      from: {\r\n        entity: fromEntity,\r\n        field: fromField\r\n      },\r\n      to: {\r\n        entity: toEntity,\r\n        field: toField\r\n      },\r\n      type,\r\n      color: metadata.color,\r\n      label: metadata.label\r\n    });\r\n  }\r\n\r\n  private _toDisplayName(name: string): string {\r\n    return name\r\n      .split('_')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1))\r\n      .join(' ');\r\n  }\r\n}\r\n","/**\r\n * Domain Value Object: Position\r\n *\r\n * Represents a 2D position on the canvas\r\n */\r\n\r\nexport interface PositionProps {\r\n    x: number;\r\n    y: number;\r\n}\r\n\r\nexport class Position {\r\n    public readonly x: number;\r\n    public readonly y: number;\r\n\r\n    constructor(props: PositionProps) {\r\n        this.x = props.x;\r\n        this.y = props.y;\r\n    }\r\n\r\n    distanceTo(other: Position): number {\r\n        const dx = this.x - other.x;\r\n        const dy = this.y - other.y;\r\n        return Math.sqrt(dx * dx + dy * dy);\r\n    }\r\n\r\n    add(other: Position): Position {\r\n        return new Position({\r\n            x: this.x + other.x,\r\n            y: this.y + other.y\r\n        });\r\n    }\r\n\r\n    equals(other: Position): boolean {\r\n        return this.x === other.x && this.y === other.y;\r\n    }\r\n\r\n    toJSON(): PositionProps {\r\n        return { x: this.x, y: this.y };\r\n    }\r\n}\r\n","/**\r\n * Connection-Based Layout Engine - Clean Implementation\r\n * Based on algo4.py - Complete translation with all 6 steps\r\n */\r\n\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\ninterface DirectedRelation {\r\n  left: string;\r\n  right: string;\r\n}\r\n\r\ninterface Cluster {\r\n  left: string[];\r\n  right: string[];\r\n}\r\n\r\nexport interface ConnectionLayerResult {\r\n  layers: Map<number, string[]>;\r\n  layerOf: Map<string, number>;\r\n}\r\n\r\nexport class ConnectionBasedLayoutEngine2 {\r\n  /**\r\n   * STEP 1: Convert parsed relationships to directed relations\r\n   */\r\n  private static convertToDirectedRelations(relationships: Relationship[]): DirectedRelation[] {\r\n    const relations: DirectedRelation[] = [];\r\n\r\n    console.log('\\n=== ÉTAPE 1 : RELATIONS DÉTECTÉES ===');\r\n    for (const rel of relationships) {\r\n      const left = rel.from.entity;\r\n      const right = rel.to.entity;\r\n\r\n      relations.push({ left, right });\r\n      console.log(`${left} -> ${right}`);\r\n    }\r\n\r\n    return relations;\r\n  }\r\n\r\n  /**\r\n   * STEP 2: Order entities - Simplified version from algo4.py\r\n   * This is hardcoded in algo4.py, so we'll use a simple approach:\r\n   * Process all relations and build entity order based on connectivity\r\n   */\r\n  private static orderEntities(relations: DirectedRelation[]): string[] {\r\n    console.log('\\n=== ÉTAPE 2 : ORDRE DES ENTITÉS ===');\r\n\r\n    // Count connections per entity\r\n    const connections = new Map<string, number>();\r\n    for (const rel of relations) {\r\n      connections.set(rel.left, (connections.get(rel.left) || 0) + 1);\r\n      connections.set(rel.right, (connections.get(rel.right) || 0) + 1);\r\n    }\r\n\r\n    // Get all entities\r\n    const allEntities = new Set<string>();\r\n    for (const rel of relations) {\r\n      allEntities.add(rel.left);\r\n      allEntities.add(rel.right);\r\n    }\r\n\r\n    // Process entities: prioritize those that appear on RIGHT (are targets)\r\n    const processed = new Set<string>();\r\n    const entityOrder: string[] = [];\r\n    const remaining = [...relations];\r\n\r\n    while (remaining.length > 0) {\r\n      // Find entities that appear on RIGHT in remaining relations\r\n      const entitiesOnRight = new Set<string>();\r\n      for (const rel of remaining) {\r\n        entitiesOnRight.add(rel.right);\r\n      }\r\n\r\n      // Choose entity with most connections among those on RIGHT\r\n      let chosenEntity: string | null = null;\r\n      let maxConnections = -1;\r\n\r\n      for (const entity of entitiesOnRight) {\r\n        if (processed.has(entity)) continue;\r\n        const conn = connections.get(entity) || 0;\r\n        if (conn > maxConnections) {\r\n          maxConnections = conn;\r\n          chosenEntity = entity;\r\n        }\r\n      }\r\n\r\n      if (!chosenEntity) break;\r\n\r\n      entityOrder.push(chosenEntity);\r\n      processed.add(chosenEntity);\r\n\r\n      // Remove relations where chosen entity is on RIGHT\r\n      const toRemove = remaining.filter(rel => rel.right === chosenEntity);\r\n      for (const rel of toRemove) {\r\n        const idx = remaining.indexOf(rel);\r\n        if (idx !== -1) remaining.splice(idx, 1);\r\n      }\r\n    }\r\n\r\n    console.log(`Ordre: ${entityOrder.join(' -> ')}`);\r\n    return entityOrder;\r\n  }\r\n\r\n  /**\r\n   * STEP 3: Build clusters\r\n   */\r\n  private static buildClusters(\r\n    entityOrder: string[],\r\n    relations: DirectedRelation[]\r\n  ): Map<string, Cluster> {\r\n    console.log('\\n=== ÉTAPE 3 : BUILD CLUSTERS ===\\n');\r\n\r\n    const clusters = new Map<string, Cluster>();\r\n\r\n    for (let i = 0; i < entityOrder.length; i++) {\r\n      const entityName = entityOrder[i];\r\n\r\n      // Construire le cluster\r\n      const clusterLeft: string[] = [];\r\n      const clusterRight = [entityName];\r\n\r\n      for (const rel of relations) {\r\n        if (rel.right === entityName && !clusterLeft.includes(rel.left)) {\r\n          clusterLeft.push(rel.left);\r\n        }\r\n      }\r\n\r\n      clusters.set(entityName, { left: clusterLeft, right: clusterRight });\r\n\r\n      console.log(`${i + 1}) Cluster '${entityName}':`);\r\n      console.log(`   ${JSON.stringify(clusterLeft)} -> ${JSON.stringify(clusterRight)}`);\r\n    }\r\n\r\n    return clusters;\r\n  }\r\n\r\n  /**\r\n   * STEP 4: Build layers with cascade movement\r\n   */\r\n  private static buildLayers(\r\n    entityOrder: string[],\r\n    clusters: Map<string, Cluster>,\r\n    relations: DirectedRelation[]\r\n  ): string[][] {\r\n    console.log('\\n=== ÉTAPE 4 : BUILD LAYERS ===\\n');\r\n\r\n    const layers: string[][] = [];\r\n\r\n    const findLayerIndex = (entity: string): number | null => {\r\n      for (let i = 0; i < layers.length; i++) {\r\n        if (layers[i].includes(entity)) return i;\r\n      }\r\n      return null;\r\n    };\r\n\r\n    const removeFromLayers = (entity: string): void => {\r\n      for (const layer of layers) {\r\n        const idx = layer.indexOf(entity);\r\n        if (idx !== -1) layer.splice(idx, 1);\r\n      }\r\n    };\r\n\r\n    const canAddToLayer = (entity: string, layerIdx: number): boolean => {\r\n      if (layerIdx >= layers.length) return true;\r\n\r\n      for (const existing of layers[layerIdx]) {\r\n        for (const rel of relations) {\r\n          if ((rel.left === entity && rel.right === existing) ||\r\n              (rel.left === existing && rel.right === entity)) {\r\n            return false;\r\n          }\r\n        }\r\n      }\r\n      return true;\r\n    };\r\n\r\n    const moveEntityToRightOfParent = (parentEntity: string, childEntity: string): number | null => {\r\n      const parentLayer = findLayerIndex(parentEntity);\r\n      if (parentLayer === null) return null;\r\n\r\n      removeFromLayers(childEntity);\r\n\r\n      for (let layerIdx = parentLayer + 1; layerIdx < layers.length; layerIdx++) {\r\n        if (canAddToLayer(childEntity, layerIdx)) {\r\n          layers[layerIdx].push(childEntity);\r\n          return layerIdx;\r\n        }\r\n      }\r\n\r\n      layers.push([childEntity]);\r\n      return layers.length - 1;\r\n    };\r\n\r\n    // Traiter chaque entité\r\n    for (let iteration = 0; iteration < entityOrder.length; iteration++) {\r\n      const entityName = entityOrder[iteration];\r\n      const cluster = clusters.get(entityName);\r\n      if (!cluster) continue;\r\n\r\n      const clusterLeft = [...cluster.left];\r\n      const clusterRight = [...cluster.right];\r\n\r\n      console.log(`${iteration + 1}) Entité '${entityName}':`);\r\n      console.log(`cluster-${entityName} -> ${JSON.stringify(clusterLeft)} -> ${JSON.stringify(clusterRight)}`);\r\n      console.log();\r\n\r\n      // Premier cluster\r\n      if (layers.length === 0) {\r\n        if (clusterLeft.length > 0) {\r\n          layers.push([...clusterLeft]);\r\n        }\r\n        layers.push([...clusterRight]);\r\n        console.log('=>');\r\n        layers.forEach((layer, idx) => {\r\n          console.log(`Layer ${idx}: ${JSON.stringify(layer)}`);\r\n        });\r\n        console.log();\r\n        continue;\r\n      }\r\n\r\n      // Chercher une ancre\r\n      let anchor: string | null = null;\r\n      let anchorLocation: 'left' | 'right' | null = null;\r\n\r\n      // Chercher dans RIGHT\r\n      for (const e of clusterRight) {\r\n        const idx = findLayerIndex(e);\r\n        if (idx !== null) {\r\n          anchor = e;\r\n          anchorLocation = 'right';\r\n          break;\r\n        }\r\n      }\r\n\r\n      // Chercher dans LEFT\r\n      if (anchor === null) {\r\n        for (const e of clusterLeft) {\r\n          const idx = findLayerIndex(e);\r\n          if (idx !== null) {\r\n            anchor = e;\r\n            anchorLocation = 'left';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Pas d'ancre\r\n      if (anchor === null) {\r\n        const newLayers: string[][] = [];\r\n        if (clusterLeft.length > 0) {\r\n          newLayers.push([...clusterLeft]);\r\n        }\r\n        newLayers.push([...clusterRight]);\r\n        layers.unshift(...newLayers);\r\n        console.log('=>');\r\n        layers.forEach((layer, idx) => {\r\n          console.log(`Layer ${idx}: ${JSON.stringify(layer)}`);\r\n        });\r\n        console.log();\r\n        continue;\r\n      }\r\n\r\n      console.log();\r\n\r\n      if (anchorLocation === 'right') {\r\n        // RIGHT existe déjà - déplacer en cascade\r\n\r\n        const getChildren = (parent: string): string[] => {\r\n          const children: string[] = [];\r\n          for (const rel of relations) {\r\n            if (rel.left === parent) {\r\n              children.push(rel.right);\r\n            }\r\n          }\r\n          return children;\r\n        };\r\n\r\n        const getAllDescendants = (root: string): string[] => {\r\n          const descendants: string[] = [];\r\n          const visited = new Set<string>();\r\n          const queue = [root];\r\n\r\n          while (queue.length > 0) {\r\n            const current = queue.shift()!;\r\n            if (visited.has(current)) continue;\r\n            visited.add(current);\r\n\r\n            const children = getChildren(current);\r\n            for (const child of children) {\r\n              if (!descendants.includes(child)) {\r\n                descendants.push(child);\r\n                queue.push(child);\r\n              }\r\n            }\r\n          }\r\n\r\n          return descendants;\r\n        };\r\n\r\n        // Supprimer RIGHT et descendants\r\n        const descendants = getAllDescendants(entityName);\r\n        removeFromLayers(entityName);\r\n        for (const desc of descendants) {\r\n          removeFromLayers(desc);\r\n        }\r\n\r\n        // Placer LEFT\r\n        for (const leftEntity of clusterLeft) {\r\n          if (findLayerIndex(leftEntity) === null) {\r\n            let placed = false;\r\n            for (let layerIdx = 0; layerIdx < layers.length; layerIdx++) {\r\n              if (canAddToLayer(leftEntity, layerIdx)) {\r\n                layers[layerIdx].push(leftEntity);\r\n                placed = true;\r\n                break;\r\n              }\r\n            }\r\n            if (!placed) {\r\n              layers.push([leftEntity]);\r\n            }\r\n          }\r\n        }\r\n\r\n        // Trouver layer max des LEFT\r\n        const leftLayers = clusterLeft\r\n          .map(e => findLayerIndex(e))\r\n          .filter(idx => idx !== null) as number[];\r\n        const maxLeftLayer = leftLayers.length > 0 ? Math.max(...leftLayers) : -1;\r\n\r\n        // Placer RIGHT\r\n        let rightPlacedLayer: number | null = null;\r\n        for (let layerIdx = maxLeftLayer + 1; layerIdx < layers.length; layerIdx++) {\r\n          if (canAddToLayer(entityName, layerIdx)) {\r\n            layers[layerIdx].push(entityName);\r\n            rightPlacedLayer = layerIdx;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (rightPlacedLayer === null) {\r\n          layers.push([entityName]);\r\n          rightPlacedLayer = layers.length - 1;\r\n        }\r\n\r\n        // Replacer descendants en cascade\r\n        if (descendants.length > 0) {\r\n          const levelMap = new Map<string, number>();\r\n          levelMap.set(entityName, 0);\r\n          const queue = [entityName];\r\n\r\n          while (queue.length > 0) {\r\n            const current = queue.shift()!;\r\n            const currentLevel = levelMap.get(current)!;\r\n            const children = getChildren(current);\r\n\r\n            for (const child of children) {\r\n              if (descendants.includes(child) && !levelMap.has(child)) {\r\n                levelMap.set(child, currentLevel + 1);\r\n                queue.push(child);\r\n              }\r\n            }\r\n          }\r\n\r\n          const descendantsSorted = descendants.sort((a, b) => {\r\n            const levelA = levelMap.get(a) || 999;\r\n            const levelB = levelMap.get(b) || 999;\r\n            return levelA - levelB;\r\n          });\r\n\r\n          for (const desc of descendantsSorted) {\r\n            let parent: string | null = null;\r\n            for (const rel of relations) {\r\n              if (rel.right === desc && (rel.left === entityName || descendantsSorted.includes(rel.left))) {\r\n                const parentLayer = findLayerIndex(rel.left);\r\n                if (parentLayer !== null) {\r\n                  parent = rel.left;\r\n                  break;\r\n                }\r\n              }\r\n            }\r\n\r\n            if (parent) {\r\n              moveEntityToRightOfParent(parent, desc);\r\n            }\r\n          }\r\n        }\r\n      } else {\r\n        // anchor_location === 'left'\r\n\r\n        const pivots: string[] = [];\r\n        for (const e of clusterLeft) {\r\n          if (e !== anchor && findLayerIndex(e) !== null) {\r\n            pivots.push(e);\r\n          }\r\n        }\r\n\r\n        const anchorLayerIdx = findLayerIndex(anchor)!;\r\n        for (const e of clusterLeft) {\r\n          if (e !== anchor && !pivots.includes(e) && !layers[anchorLayerIdx].includes(e)) {\r\n            layers[anchorLayerIdx].push(e);\r\n          }\r\n        }\r\n\r\n        let rightPlaced = false;\r\n        for (let layerIdx = anchorLayerIdx + 1; layerIdx < layers.length; layerIdx++) {\r\n          if (canAddToLayer(entityName, layerIdx)) {\r\n            layers[layerIdx].push(entityName);\r\n            rightPlaced = true;\r\n            break;\r\n          }\r\n        }\r\n\r\n        if (!rightPlaced) {\r\n          layers.push([entityName]);\r\n        }\r\n      }\r\n\r\n      console.log('=>');\r\n      layers.forEach((layer, idx) => {\r\n        console.log(`Layer ${idx}: ${JSON.stringify(layer)}`);\r\n      });\r\n      console.log();\r\n    }\r\n\r\n    // Nettoyer layers vides\r\n    return layers.filter(layer => layer.length > 0);\r\n  }\r\n\r\n  /**\r\n   * STEP 6: Reorder layers by cluster (vertical organization)\r\n   */\r\n  private static reorderLayersByCluster(\r\n    layers: string[][],\r\n    entityOrder: string[],\r\n    relations: DirectedRelation[]\r\n  ): string[][] {\r\n    console.log('\\n=== ÉTAPE 6 : RÉORGANISATION VERTICALE PAR CLUSTER ===\\n');\r\n\r\n    if (layers.length === 0) return layers;\r\n\r\n    const reorderedLayers = layers.map(l => [...l]);\r\n\r\n    // Dernier layer: ordonner selon entityOrder\r\n    const lastLayerIdx = layers.length - 1;\r\n    const lastLayer = layers[lastLayerIdx];\r\n    const orderedLast: string[] = [];\r\n\r\n    for (const entity of entityOrder) {\r\n      if (lastLayer.includes(entity)) {\r\n        orderedLast.push(entity);\r\n      }\r\n    }\r\n\r\n    for (const entity of lastLayer) {\r\n      if (!orderedLast.includes(entity)) {\r\n        orderedLast.push(entity);\r\n      }\r\n    }\r\n\r\n    reorderedLayers[lastLayerIdx] = orderedLast;\r\n    console.log(`Layer ${lastLayerIdx}: ${JSON.stringify(lastLayer)} -> ${JSON.stringify(orderedLast)}`);\r\n\r\n    // Autres layers de droite à gauche\r\n    for (let layerIdx = layers.length - 2; layerIdx >= 0; layerIdx--) {\r\n      const currentLayer = layers[layerIdx];\r\n      const nextLayer = reorderedLayers[layerIdx + 1];\r\n\r\n      console.log(`\\nLayer ${layerIdx}: ${JSON.stringify(currentLayer)}`);\r\n\r\n      // Trouver vers quelle entité du layer suivant chaque entité pointe\r\n      const entityToTarget = new Map<string, string | null>();\r\n      for (const entity of currentLayer) {\r\n        let target: string | null = null;\r\n        for (const rel of relations) {\r\n          if (rel.left === entity && nextLayer.includes(rel.right)) {\r\n            target = rel.right;\r\n            break;\r\n          }\r\n        }\r\n        entityToTarget.set(entity, target);\r\n      }\r\n\r\n      console.log(`   Connexions: ${JSON.stringify(Object.fromEntries(entityToTarget))}`);\r\n\r\n      // NOUVELLE LOGIQUE: Trouver TOUTES les cibles pour chaque entité (pas seulement la première)\r\n      const entityToAllTargets = new Map<string, string[]>();\r\n      for (const entity of currentLayer) {\r\n        const targets: string[] = [];\r\n        for (const rel of relations) {\r\n          if (rel.left === entity && nextLayer.includes(rel.right)) {\r\n            targets.push(rel.right);\r\n          }\r\n        }\r\n        entityToAllTargets.set(entity, targets);\r\n      }\r\n\r\n      console.log(`   Connexions multiples:`, Object.fromEntries(\r\n        Array.from(entityToAllTargets.entries()).map(([e, ts]) => [e, ts.length > 0 ? ts : null])\r\n      ));\r\n\r\n      // NOUVELLE STRATÉGIE: Ordonner par la position MAXIMALE de leurs cibles\r\n      // Entités pointant vers des cibles plus tôt viennent avant les entités pointant vers des cibles plus tard\r\n      const orderedLayer: string[] = [];\r\n\r\n      // 1. Calculer pour chaque entité la position max de ses cibles\r\n      const entityMaxTargetPos = new Map<string, number>();\r\n      for (const entity of currentLayer) {\r\n        const targets = entityToAllTargets.get(entity) || [];\r\n        if (targets.length === 0) {\r\n          entityMaxTargetPos.set(entity, -1); // Pas de cible = vient en premier\r\n        } else {\r\n          const maxPos = Math.max(...targets.map(t => nextLayer.indexOf(t)));\r\n          entityMaxTargetPos.set(entity, maxPos);\r\n        }\r\n      }\r\n\r\n      console.log(`   Max target positions:`, Object.fromEntries(entityMaxTargetPos));\r\n\r\n      // 2. Trier les entités par position maximale de cible\r\n      const sortedEntities = [...currentLayer].sort((a, b) => {\r\n        const posA = entityMaxTargetPos.get(a) ?? 999;\r\n        const posB = entityMaxTargetPos.get(b) ?? 999;\r\n\r\n        if (posA !== posB) {\r\n          return posA - posB; // Position max plus petite = vient en premier\r\n        }\r\n\r\n        // Si même position max, utiliser entityOrder\r\n        const indexA = entityOrder.indexOf(a);\r\n        const indexB = entityOrder.indexOf(b);\r\n        if (indexA === -1 && indexB === -1) return 0;\r\n        if (indexA === -1) return 1;\r\n        if (indexB === -1) return -1;\r\n        return indexA - indexB;\r\n      });\r\n\r\n      orderedLayer.push(...sortedEntities);\r\n\r\n      // Log clusters for debugging\r\n      const clustersByTarget = new Map<string, string[]>();\r\n      for (const targetEntity of nextLayer) {\r\n        const entities = currentLayer.filter(e =>\r\n          (entityToAllTargets.get(e) || []).includes(targetEntity)\r\n        );\r\n        if (entities.length > 0) {\r\n          clustersByTarget.set(targetEntity, entities);\r\n        }\r\n      }\r\n      for (const [target, entities] of clustersByTarget) {\r\n        console.log(`   Cluster -> ${target}: ${JSON.stringify(entities)}`);\r\n      }\r\n\r\n      reorderedLayers[layerIdx] = orderedLayer;\r\n      console.log(`   => ${JSON.stringify(orderedLayer)}`);\r\n    }\r\n\r\n    return reorderedLayers;\r\n  }\r\n\r\n  /**\r\n   * Main entry point\r\n   */\r\n  static layout(entities: Entity[], relationships: Relationship[]): ConnectionLayerResult {\r\n    // Step 1: Convert to directed relations\r\n    const relations = this.convertToDirectedRelations(relationships);\r\n\r\n    // Step 2: Order entities\r\n    const entityOrder = this.orderEntities(relations);\r\n\r\n    // Step 3: Build clusters\r\n    const clusters = this.buildClusters(entityOrder, relations);\r\n\r\n    // Step 4: Build layers\r\n    let layers = this.buildLayers(entityOrder, clusters, relations);\r\n\r\n    // Step 6: Reorder by cluster (vertical organization)\r\n    layers = this.reorderLayersByCluster(layers, entityOrder, relations);\r\n\r\n    console.log('\\n=== RÉSULTAT FINAL AVEC ORGANISATION VERTICALE ===\\n');\r\n    layers.forEach((layer, idx) => {\r\n      console.log(`Layer ${idx}: ${JSON.stringify(layer)}`);\r\n    });\r\n\r\n    // Build result maps\r\n    const layersMap = new Map<number, string[]>();\r\n    const layerOf = new Map<string, number>();\r\n\r\n    layers.forEach((layer, idx) => {\r\n      layersMap.set(idx, layer);\r\n      layer.forEach(entity => {\r\n        layerOf.set(entity, idx);\r\n      });\r\n    });\r\n\r\n    // Handle isolated entities\r\n    entities.forEach(entity => {\r\n      if (!layerOf.has(entity.name)) {\r\n        const maxLayer = Math.max(...Array.from(layerOf.values()), -1);\r\n        layerOf.set(entity.name, maxLayer + 1);\r\n        if (!layersMap.has(maxLayer + 1)) {\r\n          layersMap.set(maxLayer + 1, []);\r\n        }\r\n        layersMap.get(maxLayer + 1)!.push(entity.name);\r\n      }\r\n    });\r\n\r\n    return { layers: layersMap, layerOf };\r\n  }\r\n}\r\n","/**\r\n * Layout Positioner\r\n *\r\n * Calculates screen positions for entities based on their hierarchical layers.\r\n * Takes into account entity heights to avoid overlaps.\r\n */\r\n\r\nimport { Position } from '../../domain/value-objects/Position';\r\nimport { Entity } from '../../domain/entities/Entity';\r\n\r\nexport interface LayoutConfig {\r\n  entityWidth: number;\r\n  entityHeaderHeight: number;\r\n  entityFieldHeight: number;\r\n  horizontalSpacing: number;\r\n  verticalSpacing: number;  // Minimum gap between entities\r\n  baseX: number;\r\n  displayHeight: number;\r\n}\r\n\r\nexport class LayoutPositioner {\r\n  /**\r\n   * Calculate the height of an entity based on its fields\r\n   */\r\n  static calculateEntityHeight(\r\n    entity: Entity,\r\n    headerHeight: number,\r\n    fieldHeight: number\r\n  ): number {\r\n    return headerHeight + entity.fields.length * fieldHeight;\r\n  }\r\n\r\n  /**\r\n   * Calculate positions for entities in horizontal layout (left to right)\r\n   * Avoids overlaps by considering actual entity heights\r\n   *\r\n   * @param layers - Map of layer index to entity names\r\n   * @param entities - All entities (to calculate heights)\r\n   * @param config - Layout configuration\r\n   * @returns Map of entity name to position\r\n   */\r\n  static calculatePositions(\r\n    layers: Map<number, string[]>,\r\n    entities: Entity[],\r\n    config: LayoutConfig\r\n  ): Map<string, Position> {\r\n    const positions = new Map<string, Position>();\r\n\r\n    // Create entity lookup map\r\n    const entityMap = new Map<string, Entity>();\r\n    entities.forEach(e => entityMap.set(e.name, e));\r\n\r\n    // Sort layers by index and position entities\r\n    for (const [layerIndex, layerNodes] of Array.from(layers.entries()).sort((a, b) => a[0] - b[0])) {\r\n      // Calculate total height needed for this layer (including entity heights + spacing)\r\n      let totalHeight = 0;\r\n      const entityHeights: number[] = [];\r\n\r\n      layerNodes.forEach(name => {\r\n        const entity = entityMap.get(name);\r\n        if (entity) {\r\n          const height = this.calculateEntityHeight(\r\n            entity,\r\n            config.entityHeaderHeight,\r\n            config.entityFieldHeight\r\n          );\r\n          entityHeights.push(height);\r\n          totalHeight += height;\r\n        } else {\r\n          // Fallback if entity not found\r\n          entityHeights.push(config.entityHeaderHeight);\r\n          totalHeight += config.entityHeaderHeight;\r\n        }\r\n      });\r\n\r\n      // Add spacing between entities\r\n      totalHeight += (layerNodes.length - 1) * config.verticalSpacing;\r\n\r\n      // Calculate starting Y position (center the layer vertically)\r\n      let currentY = Math.max(0, (config.displayHeight - totalHeight) / 2);\r\n      const x = config.baseX + layerIndex * config.horizontalSpacing;\r\n\r\n      // Position each entity\r\n      layerNodes.forEach((name, i) => {\r\n        positions.set(name, new Position({ x, y: currentY }));\r\n\r\n        // Move Y down by entity height + spacing for next entity\r\n        currentY += entityHeights[i] + config.verticalSpacing;\r\n      });\r\n    }\r\n\r\n    return positions;\r\n  }\r\n}\r\n","/**\r\n * Field Ordering Algorithm\r\n *\r\n * Determines the optimal ORDER of fields within each entity to minimize\r\n * edge crossings between field connections.\r\n *\r\n * Key insight: Fields should be ordered based on the VERTICAL POSITION\r\n * of their connected entities in neighboring layers.\r\n *\r\n * Example:\r\n *   If entity A has fields [f1, f2] where:\r\n *   - f1 connects to Entity X (position 0 in layer)\r\n *   - f2 connects to Entity Y (position 1 in layer)\r\n *   Then f1 should come before f2 to avoid crossings\r\n */\r\n\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { reorderEntityFields } from '../../data/models/utils';\r\n\r\nexport class FieldOrderingAlgorithm {\r\n  /**\r\n   * Optimize field ordering within all entities\r\n   *\r\n   * @param entities - All entities\r\n   * @param relationships - All relationships\r\n   * @param orderedLayers - Layers with entities already ordered vertically\r\n   */\r\n  static optimize(\r\n    entities: Entity[],\r\n    relationships: Relationship[],\r\n    orderedLayers: Map<number, string[]>\r\n  ): void {\r\n    console.log('=== FIELD ORDERING ALGORITHM ===');\r\n\r\n    // Build entity position map (what is the vertical position of each entity?)\r\n    const entityVerticalPosition = new Map<string, number>();\r\n    orderedLayers.forEach((layerEntities) => {\r\n      layerEntities.forEach((entityName, position) => {\r\n        entityVerticalPosition.set(entityName, position);\r\n      });\r\n    });\r\n\r\n    // Multiple passes for convergence\r\n    // Each pass reorders fields based on current entity positions\r\n    for (let pass = 0; pass < 3; pass++) {\r\n      entities.forEach(entity => {\r\n        const fieldConnectionPositions = new Map<string, number[]>();\r\n\r\n        // For each field, find the vertical positions of entities it connects to\r\n        entity.fields.forEach((field) => {\r\n          const connectedEntityPositions: number[] = [];\r\n\r\n          relationships.forEach(rel => {\r\n            let targetEntityName: string | null = null;\r\n\r\n            // Check outgoing connections (this field connects to another entity)\r\n            if (rel.from.entity === entity.name && rel.from.field === field.name) {\r\n              targetEntityName = rel.to.entity;\r\n            }\r\n            // Check incoming connections (another entity connects to this field)\r\n            else if (rel.to.entity === entity.name && rel.to.field === field.name) {\r\n              targetEntityName = rel.from.entity;\r\n            }\r\n\r\n            if (targetEntityName) {\r\n              const targetEntityPos = entityVerticalPosition.get(targetEntityName);\r\n              if (targetEntityPos !== undefined) {\r\n                connectedEntityPositions.push(targetEntityPos);\r\n              }\r\n            }\r\n          });\r\n\r\n          fieldConnectionPositions.set(field.name, connectedEntityPositions);\r\n        });\r\n\r\n        // Sort fields by average connected entity vertical position\r\n        const fieldOrder = entity.fields\r\n          .map(field => {\r\n            const targetPositions = fieldConnectionPositions.get(field.name) || [];\r\n            const avgPos = targetPositions.length > 0\r\n              ? targetPositions.reduce((sum, pos) => sum + pos, 0) / targetPositions.length\r\n              : Infinity; // Fields with no connections go to the bottom\r\n\r\n            return {\r\n              name: field.name,\r\n              avgTargetPos: avgPos,\r\n              hasConnections: targetPositions.length > 0\r\n            };\r\n          })\r\n          .sort((a, b) => {\r\n            // Fields with connections come first, sorted by their target positions\r\n            // Fields without connections go to the bottom\r\n            if (a.avgTargetPos === Infinity && b.avgTargetPos === Infinity) return 0;\r\n            if (a.avgTargetPos === Infinity) return 1;\r\n            if (b.avgTargetPos === Infinity) return -1;\r\n\r\n            return a.avgTargetPos - b.avgTargetPos;\r\n          })\r\n          .map(f => f.name);\r\n\r\n        // Apply the new field order\r\n        reorderEntityFields(entity, fieldOrder);\r\n\r\n        // Log significant reorderings\r\n        const originalOrder = entity.fields.map(f => f.name);\r\n        if (JSON.stringify(originalOrder) !== JSON.stringify(fieldOrder)) {\r\n          console.log(`  Reordered fields in ${entity.name}:`, fieldOrder);\r\n        }\r\n      });\r\n    }\r\n\r\n    console.log('=== FIELD ORDERING COMPLETE ===\\n');\r\n  }\r\n}\r\n","/**\r\n * Magnetic Alignment Optimizer\r\n *\r\n * Handles field ordering within entities to optimize visual alignment.\r\n *\r\n * NOTE: Entity layering and ordering is now handled by ConnectionBasedLayoutEngine\r\n * which includes:\r\n * - Horizontal layering (X positions)\r\n * - Cluster-based vertical ordering (Y positions within layers)\r\n * - Pivot detection and placement\r\n *\r\n * This class only handles field ordering within individual entities.\r\n */\r\n\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { FieldOrderingAlgorithm } from './FieldOrderingAlgorithm';\r\n\r\nexport class MagneticAlignmentOptimizer {\r\n  /**\r\n   * Optimize field ordering within entities\r\n   *\r\n   * @param entities - All entities\r\n   * @param relationships - All relationships\r\n   * @param layers - Layers from ConnectionBasedLayoutEngine (already ordered)\r\n   * @returns The same layers (entities are not reordered, only fields within entities)\r\n   */\r\n  static optimize(\r\n    entities: Entity[],\r\n    relationships: Relationship[],\r\n    layers: Map<number, string[]>\r\n  ): Map<number, string[]> {\r\n    console.log('\\n=== FIELD ORDERING OPTIMIZER ===');\r\n    console.log('Optimizing field order within entities...\\n');\r\n\r\n    // Optimize field ordering within entities\r\n    FieldOrderingAlgorithm.optimize(entities, relationships, layers);\r\n\r\n    console.log('=== FIELD ORDERING COMPLETE ===\\n');\r\n    return layers;\r\n  }\r\n}\r\n","/**\r\n * Infrastructure Adapter: Canvas Renderer\r\n *\r\n * Adapts the canvas renderer to implement IRenderer\r\n */\r\nimport { IRenderer } from '../../domain/repositories/IRenderer';\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { Position } from '../../domain/value-objects/Position';\r\nimport { ConnectionBasedLayoutEngine2 } from '../layout/ConnectionBasedLayoutEngine';\r\nimport { LayoutPositioner } from '../layout/LayoutPositioner';\r\nimport { MagneticAlignmentOptimizer } from '../layout/MagneticAlignmentOptimizer';\r\nimport { getRelationshipCardinality } from '../../data/models/utils';\r\n\r\ninterface MousePosition {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\nexport class CanvasRendererAdapter implements IRenderer {\r\n  private canvas: HTMLCanvasElement;\r\n  private ctx: CanvasRenderingContext2D;\r\n  private entities: Entity[] = [];\r\n  private relationships: Relationship[] = [];\r\n\r\n  // Rendering state\r\n  private zoom: number = 1.0;\r\n  private panX: number = 50;\r\n  private panY: number = 50;\r\n  private isDragging: boolean = false;\r\n  private isPanning: boolean = false;\r\n  private dragEntity: Entity | null = null;\r\n  private dragOffset: MousePosition = { x: 0, y: 0 };\r\n  private lastMousePos: MousePosition = { x: 0, y: 0 };\r\n\r\n  // Entity layout\r\n  private entityPositions: Map<string, Position> = new Map();\r\n  private readonly entityWidth: number = 250;\r\n  private readonly entityHeaderHeight: number = 50;\r\n  private readonly entityFieldHeight: number = 30;\r\n  private readonly entityPadding: number = 60;\r\n\r\n  // Display dimensions\r\n  private displayWidth: number = 0;\r\n  private displayHeight: number = 0;\r\n\r\n  // Colors\r\n  private readonly colors = {\r\n    background: '#ffffff',\r\n    gridLine: 'rgba(0,0,0,0.05)',\r\n    entityBorder: '#e2e8f0',\r\n    entityShadow: 'rgba(0,0,0,0.1)',\r\n    fieldText: '#475569',\r\n    relationLine: '#3b82f6',\r\n    primaryKeyBg: '#dbeafe',\r\n    foreignKeyBg: '#fef3c7'\r\n  };\r\n\r\n  constructor(canvas: HTMLCanvasElement) {\r\n    this.canvas = canvas;\r\n    const ctx = canvas.getContext('2d');\r\n    if (!ctx) {\r\n      throw new Error('Could not get 2D context from canvas');\r\n    }\r\n    this.ctx = ctx;\r\n\r\n    this._setupCanvas();\r\n    this._setupEventListeners();\r\n  }\r\n\r\n  setData(entities: Entity[], relationships: Relationship[]): void {\r\n    this.entities = entities;\r\n    this.relationships = relationships;\r\n\r\n    // Apply auto-layout automatically if there are entities\r\n    if (this.entities.length > 0) {\r\n      this.autoLayout();\r\n    } else {\r\n      this._initializePositions();\r\n      this.render();\r\n    }\r\n  }\r\n\r\n  render(): void {\r\n    const ctx = this.ctx;\r\n    const width = this.displayWidth;\r\n    const height = this.displayHeight;\r\n\r\n    ctx.clearRect(0, 0, width, height);\r\n    ctx.save();\r\n    ctx.translate(this.panX, this.panY);\r\n    ctx.scale(this.zoom, this.zoom);\r\n\r\n    this._drawRelationships(ctx);\r\n    this._drawEntities(ctx);\r\n\r\n    ctx.restore();\r\n  }\r\n\r\n  zoomIn(): void {\r\n    const centerX = this.displayWidth / 2;\r\n    const centerY = this.displayHeight / 2;\r\n\r\n    const newZoom = Math.min(3.0, this.zoom * 1.2);\r\n    const zoomChange = newZoom / this.zoom;\r\n\r\n    this.panX = centerX - (centerX - this.panX) * zoomChange;\r\n    this.panY = centerY - (centerY - this.panY) * zoomChange;\r\n    this.zoom = newZoom;\r\n\r\n    this.render();\r\n  }\r\n\r\n  zoomOut(): void {\r\n    const centerX = this.displayWidth / 2;\r\n    const centerY = this.displayHeight / 2;\r\n\r\n    const newZoom = Math.max(0.1, this.zoom / 1.2);\r\n    const zoomChange = newZoom / this.zoom;\r\n\r\n    this.panX = centerX - (centerX - this.panX) * zoomChange;\r\n    this.panY = centerY - (centerY - this.panY) * zoomChange;\r\n    this.zoom = newZoom;\r\n\r\n    this.render();\r\n  }\r\n\r\n  fitToScreen(): void {\r\n    if (this.entities.length === 0) return;\r\n\r\n    let minX = Infinity, minY = Infinity;\r\n    let maxX = -Infinity, maxY = -Infinity;\r\n\r\n    for (const entity of this.entities) {\r\n      const pos = this.entityPositions.get(entity.name);\r\n      if (!pos) continue;\r\n\r\n      minX = Math.min(minX, pos.x);\r\n      minY = Math.min(minY, pos.y);\r\n      maxX = Math.max(maxX, pos.x + this.entityWidth);\r\n      maxY = Math.max(maxY, pos.y + this.entityHeaderHeight + (entity.fields.length * this.entityFieldHeight));\r\n    }\r\n\r\n    if (!isFinite(minX)) return;\r\n\r\n    const contentWidth = maxX - minX;\r\n    const contentHeight = maxY - minY;\r\n    const padding = 100;\r\n\r\n    const zoomX = (this.displayWidth - padding) / contentWidth;\r\n    const zoomY = (this.displayHeight - padding) / contentHeight;\r\n    this.zoom = Math.min(zoomX, zoomY, 1.0);\r\n\r\n    this.panX = (this.displayWidth - contentWidth * this.zoom) / 2 - minX * this.zoom;\r\n    this.panY = (this.displayHeight - contentHeight * this.zoom) / 2 - minY * this.zoom;\r\n\r\n    this.render();\r\n  }\r\n\r\n  autoLayout(): void {\r\n    this.entityPositions.clear();\r\n\r\n    // Step 1-6: Compute hierarchical layers using connection-based algorithm\r\n    // This algorithm includes:\r\n    // - Step 1: Parse relationships and apply position rule\r\n    // - Step 2: Order relationships by entity\r\n    // - Step 3: Build clusters\r\n    // - Step 4: Build layers from clusters\r\n    // - Step 5: Optimize layers by merging compatible ones\r\n    // - Step 6: Reorder elements within layers based on cluster alignment\r\n    const { layers } = ConnectionBasedLayoutEngine2.layout(this.entities, this.relationships);\r\n\r\n    // Step 7: Field ordering within entities (only reorder fields, not entities)\r\n    const finalLayers = MagneticAlignmentOptimizer.optimize(\r\n      this.entities,\r\n      this.relationships,\r\n      layers\r\n    );\r\n\r\n    // Step 8: Calculate positions based on optimized ordering\r\n    const positions = LayoutPositioner.calculatePositions(\r\n      finalLayers,\r\n      this.entities,  // Pass entities to calculate heights\r\n      {\r\n        entityWidth: this.entityWidth,\r\n        entityHeaderHeight: this.entityHeaderHeight,\r\n        entityFieldHeight: this.entityFieldHeight,\r\n        horizontalSpacing: this.entityWidth + 120,\r\n        verticalSpacing: 10,  // Minimum gap between entities\r\n        baseX: 100,\r\n        displayHeight: this.displayHeight\r\n      }\r\n    );\r\n\r\n    // Apply positions\r\n    this.entityPositions = positions;\r\n\r\n    // Step 9: Debug output\r\n    this._logLayoutDebugInfo(finalLayers);\r\n\r\n    // Step 10: Fit to screen\r\n    this.fitToScreen();\r\n  }\r\n\r\n  /**\r\n   * Log debug information about the layout\r\n   */\r\n  private _logLayoutDebugInfo(layers: Map<number, string[]>): void {\r\n    console.groupCollapsed('🧭 Auto Layout Layers (Left → Right)');\r\n    console.log(`Number of layers detected: ${layers.size}`);\r\n    for (const [i, names] of Array.from(layers.entries()).sort((a, b) => a[0] - b[0])) {\r\n      console.log(`Layer ${i}: ${names.join(', ')}`);\r\n    }\r\n    console.groupEnd();\r\n  }\r\n\r\n  getZoomLevel(): number {\r\n    return Math.round(this.zoom * 100);\r\n  }\r\n\r\n  // Private methods\r\n  private _setupCanvas(): void {\r\n    this._resizeCanvas();\r\n    window.addEventListener('resize', () => {\r\n      this._resizeCanvas();\r\n      this.render();\r\n    });\r\n  }\r\n\r\n  private _resizeCanvas(): void {\r\n    const rect = this.canvas.getBoundingClientRect();\r\n    const dpr = window.devicePixelRatio || 1;\r\n    this.canvas.width = rect.width * dpr;\r\n    this.canvas.height = rect.height * dpr;\r\n    this.ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n    this.ctx.scale(dpr, dpr);\r\n    this.displayWidth = rect.width;\r\n    this.displayHeight = rect.height;\r\n  }\r\n\r\n  private _setupEventListeners(): void {\r\n    let isMouseDown = false;\r\n\r\n    this.canvas.addEventListener('mousedown', (e: MouseEvent) => {\r\n      isMouseDown = true;\r\n      const worldPos = this._screenToWorld(e.clientX, e.clientY);\r\n      const clickedEntity = this._getEntityAtPoint(worldPos.x, worldPos.y);\r\n\r\n      if (clickedEntity) {\r\n        this.isDragging = true;\r\n        this.isPanning = false;\r\n        this.dragEntity = clickedEntity;\r\n        const pos = this.entityPositions.get(clickedEntity.name)!;\r\n        this.dragOffset = {\r\n          x: worldPos.x - pos.x,\r\n          y: worldPos.y - pos.y\r\n        };\r\n        this.canvas.style.cursor = 'move';\r\n      } else if (this.entities.length > 0) {\r\n        this.isPanning = true;\r\n        this.isDragging = false;\r\n        this.dragEntity = null;\r\n        this.lastMousePos = { x: e.clientX, y: e.clientY };\r\n        this.canvas.style.cursor = 'grabbing';\r\n      }\r\n    });\r\n\r\n    this.canvas.addEventListener('mousemove', (e: MouseEvent) => {\r\n      if (!isMouseDown) {\r\n        if (this.entities.length > 0) {\r\n          const worldPos = this._screenToWorld(e.clientX, e.clientY);\r\n          const hoveredEntity = this._getEntityAtPoint(worldPos.x, worldPos.y);\r\n          this.canvas.style.cursor = hoveredEntity ? 'pointer' : 'default';\r\n        } else {\r\n          this.canvas.style.cursor = 'default';\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (this.isDragging && this.dragEntity) {\r\n        const worldPos = this._screenToWorld(e.clientX, e.clientY);\r\n        this.entityPositions.set(this.dragEntity.name, new Position({\r\n          x: worldPos.x - this.dragOffset.x,\r\n          y: worldPos.y - this.dragOffset.y\r\n        }));\r\n        this.render();\r\n      } else if (this.isPanning) {\r\n        const dx = e.clientX - this.lastMousePos.x;\r\n        const dy = e.clientY - this.lastMousePos.y;\r\n        this.panX += dx;\r\n        this.panY += dy;\r\n        this.lastMousePos = { x: e.clientX, y: e.clientY };\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    const stopDragging = (e?: MouseEvent) => {\r\n      isMouseDown = false;\r\n      this.isDragging = false;\r\n      this.isPanning = false;\r\n      this.dragEntity = null;\r\n\r\n      if (this.entities.length > 0 && e) {\r\n        const worldPos = this._screenToWorld(e.clientX, e.clientY);\r\n        const hoveredEntity = this._getEntityAtPoint(worldPos.x, worldPos.y);\r\n        this.canvas.style.cursor = hoveredEntity ? 'pointer' : 'default';\r\n      } else {\r\n        this.canvas.style.cursor = 'default';\r\n      }\r\n    };\r\n\r\n    this.canvas.addEventListener('mouseup', stopDragging);\r\n    this.canvas.addEventListener('mouseleave', stopDragging);\r\n\r\n    this.canvas.addEventListener('wheel', (e: WheelEvent) => {\r\n      e.preventDefault();\r\n      const rect = this.canvas.getBoundingClientRect();\r\n      const mouseX = e.clientX - rect.left;\r\n      const mouseY = e.clientY - rect.top;\r\n\r\n      const zoomDelta = e.deltaY > 0 ? 0.9 : 1.1;\r\n      const newZoom = Math.max(0.1, Math.min(3.0, this.zoom * zoomDelta));\r\n\r\n      const zoomChange = newZoom / this.zoom;\r\n      this.panX = mouseX - (mouseX - this.panX) * zoomChange;\r\n      this.panY = mouseY - (mouseY - this.panY) * zoomChange;\r\n\r\n      this.zoom = newZoom;\r\n      this.render();\r\n    });\r\n  }\r\n\r\n  private _screenToWorld(screenX: number, screenY: number): MousePosition {\r\n    const rect = this.canvas.getBoundingClientRect();\r\n    const x = (screenX - rect.left - this.panX) / this.zoom;\r\n    const y = (screenY - rect.top - this.panY) / this.zoom;\r\n    return { x, y };\r\n  }\r\n\r\n  private _getEntityAtPoint(x: number, y: number): Entity | null {\r\n    for (let i = this.entities.length - 1; i >= 0; i--) {\r\n      const entity = this.entities[i];\r\n      const pos = this.entityPositions.get(entity.name);\r\n      if (!pos) continue;\r\n\r\n      const width = this.entityWidth;\r\n      const height = this.entityHeaderHeight + (entity.fields.length * this.entityFieldHeight);\r\n\r\n      if (x >= pos.x && x <= pos.x + width &&\r\n        y >= pos.y && y <= pos.y + height) {\r\n        return entity;\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private _initializePositions(): void {\r\n    const cols = Math.ceil(Math.sqrt(this.entities.length));\r\n    const spacing = this.entityWidth + this.entityPadding * 2;\r\n\r\n    this.entities.forEach((entity, index) => {\r\n      if (!this.entityPositions.has(entity.name)) {\r\n        const row = Math.floor(index / cols);\r\n        const col = index % cols;\r\n\r\n        this.entityPositions.set(entity.name, new Position({\r\n          x: col * spacing + this.entityPadding,\r\n          y: row * (300 + this.entityPadding) + this.entityPadding\r\n        }));\r\n      }\r\n    });\r\n  }\r\n\r\n  private _drawEntities(ctx: CanvasRenderingContext2D): void {\r\n    for (const entity of this.entities) {\r\n      const pos = this.entityPositions.get(entity.name);\r\n      if (!pos) continue;\r\n      this._drawEntity(ctx, entity, pos.x, pos.y);\r\n    }\r\n  }\r\n\r\n  private _drawEntity(ctx: CanvasRenderingContext2D, entity: Entity, x: number, y: number): void {\r\n    const width = this.entityWidth;\r\n    const headerHeight = this.entityHeaderHeight;\r\n    const fieldHeight = this.entityFieldHeight;\r\n    const totalHeight = headerHeight + (entity.fields.length * fieldHeight);\r\n\r\n    ctx.shadowColor = this.colors.entityShadow;\r\n    ctx.shadowBlur = 10;\r\n    ctx.shadowOffsetX = 0;\r\n    ctx.shadowOffsetY = 2;\r\n\r\n    ctx.fillStyle = '#ffffff';\r\n    ctx.fillRect(x, y, width, totalHeight);\r\n\r\n    ctx.shadowColor = 'transparent';\r\n    ctx.shadowBlur = 0;\r\n\r\n    ctx.strokeStyle = this.colors.entityBorder;\r\n    ctx.lineWidth = 2;\r\n    ctx.strokeRect(x, y, width, totalHeight);\r\n\r\n    ctx.fillStyle = entity.color || '#3b82f6';\r\n    ctx.fillRect(x, y, width, headerHeight);\r\n\r\n    ctx.fillStyle = '#ffffff';\r\n    ctx.font = 'bold 16px -apple-system, sans-serif';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'middle';\r\n    ctx.fillText(entity.displayName, x + width / 2, y + headerHeight / 2);\r\n\r\n    entity.fields.forEach((field, index) => {\r\n      const fieldY = y + headerHeight + (index * fieldHeight);\r\n      this._drawField(ctx, field, x, fieldY, width, fieldHeight);\r\n    });\r\n  }\r\n\r\n  private _drawField(ctx: CanvasRenderingContext2D, field: any, x: number, y: number, width: number, height: number): void {\r\n    if (field.isPrimaryKey) {\r\n      ctx.fillStyle = this.colors.primaryKeyBg;\r\n      ctx.fillRect(x, y, width, height);\r\n    } else if (field.isForeignKey) {\r\n      ctx.fillStyle = this.colors.foreignKeyBg;\r\n      ctx.fillRect(x, y, width, height);\r\n    }\r\n\r\n    ctx.strokeStyle = this.colors.entityBorder;\r\n    ctx.lineWidth = 1;\r\n    ctx.beginPath();\r\n    ctx.moveTo(x, y);\r\n    ctx.lineTo(x + width, y);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = this.colors.fieldText;\r\n    ctx.font = '14px -apple-system, monospace';\r\n    ctx.textAlign = 'left';\r\n    ctx.textBaseline = 'middle';\r\n\r\n    let fieldText = field.name;\r\n    if (field.isPrimaryKey) fieldText += ' 🔑';\r\n    if (field.isForeignKey) fieldText += ' 🔗';\r\n    if (field.isUnique) fieldText += ' ✦';\r\n\r\n    ctx.fillText(fieldText, x + 10, y + height / 2);\r\n\r\n    ctx.fillStyle = '#94a3b8';\r\n    ctx.font = '12px -apple-system, monospace';\r\n    ctx.textAlign = 'right';\r\n    ctx.fillText(field.type, x + width - 10, y + height / 2);\r\n  }\r\n\r\n  private _drawRelationships(ctx: CanvasRenderingContext2D): void {\r\n    for (const rel of this.relationships) {\r\n      this._drawRelationship(ctx, rel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the Y coordinate of a specific field within an entity\r\n   */\r\n  private _getFieldYPosition(entity: Entity, fieldName: string, entityPos: Position): number {\r\n    const fieldIndex = entity.fields.findIndex(f => f.name === fieldName);\r\n    if (fieldIndex === -1) {\r\n      // Field not found, default to entity center\r\n      return entityPos.y + this.entityHeaderHeight + (entity.fields.length * this.entityFieldHeight) / 2;\r\n    }\r\n    // Return the vertical center of the field\r\n    return entityPos.y + this.entityHeaderHeight + (fieldIndex * this.entityFieldHeight) + (this.entityFieldHeight / 2);\r\n  }\r\n\r\n  private _drawRelationship(ctx: CanvasRenderingContext2D, relationship: Relationship): void {\r\n    const fromEntity = this.entities.find(e => e.name === relationship.from.entity);\r\n    const toEntity = this.entities.find(e => e.name === relationship.to.entity);\r\n\r\n    if (!fromEntity || !toEntity) return;\r\n\r\n    const fromPos = this.entityPositions.get(fromEntity.name);\r\n    const toPos = this.entityPositions.get(toEntity.name);\r\n\r\n    if (!fromPos || !toPos) return;\r\n\r\n    // Get field-specific Y positions\r\n    const fromFieldY = this._getFieldYPosition(fromEntity, relationship.from.field, fromPos);\r\n    const toFieldY = this._getFieldYPosition(toEntity, relationship.to.field, toPos);\r\n\r\n    // Calculate entity centers for X positioning logic\r\n    const fromCenterX = fromPos.x + this.entityWidth / 2;\r\n    const toCenterX = toPos.x + this.entityWidth / 2;\r\n\r\n    // Determine which side to connect from based on relative horizontal positions\r\n    const dx = toCenterX - fromCenterX;\r\n\r\n    let fromX: number, fromY: number, toX: number, toY: number;\r\n\r\n    // Horizontal connection logic (left-to-right layout)\r\n    if (dx > 0) {\r\n      // From is left of To - connect from right edge of 'from' to left edge of 'to'\r\n      fromX = fromPos.x + this.entityWidth;\r\n      fromY = fromFieldY;\r\n      toX = toPos.x;\r\n      toY = toFieldY;\r\n    } else if (dx < 0) {\r\n      // From is right of To - connect from left edge of 'from' to right edge of 'to'\r\n      fromX = fromPos.x;\r\n      fromY = fromFieldY;\r\n      toX = toPos.x + this.entityWidth;\r\n      toY = toFieldY;\r\n    } else {\r\n      // Entities are vertically aligned - use top/bottom connection\r\n      if (fromFieldY < toFieldY) {\r\n        // From is above To\r\n        fromX = fromCenterX;\r\n        fromY = fromPos.y + this.entityHeaderHeight + (fromEntity.fields.length * this.entityFieldHeight);\r\n        toX = toCenterX;\r\n        toY = toPos.y;\r\n      } else {\r\n        // From is below To\r\n        fromX = fromCenterX;\r\n        fromY = fromPos.y;\r\n        toX = toCenterX;\r\n        toY = toPos.y + this.entityHeaderHeight + (toEntity.fields.length * this.entityFieldHeight);\r\n      }\r\n    }\r\n\r\n    // Use custom color if provided, otherwise use default\r\n    const lineColor = relationship.color || this.colors.relationLine;\r\n    ctx.strokeStyle = lineColor;\r\n    ctx.fillStyle = lineColor;\r\n    ctx.lineWidth = 2;\r\n    ctx.setLineDash([5, 5]);\r\n\r\n    // Draw line with orthogonal routing for horizontal connections\r\n    ctx.beginPath();\r\n    ctx.moveTo(fromX, fromY);\r\n\r\n    // For horizontal layout, use orthogonal routing with midpoint\r\n    if (dx !== 0) {\r\n      // Horizontal connection - use orthogonal routing\r\n      const midX = (fromX + toX) / 2;\r\n      ctx.lineTo(midX, fromY);\r\n      ctx.lineTo(midX, toY);\r\n      ctx.lineTo(toX, toY);\r\n    } else {\r\n      // Vertical connection - direct line with midpoint\r\n      const midY = (fromY + toY) / 2;\r\n      ctx.lineTo(fromX, midY);\r\n      ctx.lineTo(toX, midY);\r\n      ctx.lineTo(toX, toY);\r\n    }\r\n\r\n    ctx.stroke();\r\n    ctx.setLineDash([]);\r\n\r\n    // Draw cardinality markers based on relationship type\r\n    this._drawCardinalityMarkers(ctx, relationship, fromX, fromY, toX, toY, lineColor);\r\n\r\n    // Calculate label position at midpoint\r\n    const labelX = (fromX + toX) / 2;\r\n    const labelY = (fromY + toY) / 2;\r\n\r\n    // Draw label if provided\r\n    if (relationship.label) {\r\n      ctx.fillStyle = lineColor;\r\n      ctx.font = 'italic 11px -apple-system, sans-serif';\r\n      ctx.textAlign = 'center';\r\n      ctx.textBaseline = 'top';\r\n      ctx.fillText(relationship.label, labelX, labelY + 5);\r\n    }\r\n\r\n    // Draw cardinality text\r\n    ctx.fillStyle = lineColor;\r\n    ctx.font = 'bold 12px -apple-system, sans-serif';\r\n    ctx.textAlign = 'center';\r\n    ctx.textBaseline = 'bottom';\r\n    ctx.fillText(getRelationshipCardinality(relationship), labelX, labelY - 5);\r\n  }\r\n\r\n  private _drawCardinalityMarkers(ctx: CanvasRenderingContext2D, relationship: Relationship, fromX: number, fromY: number, toX: number, toY: number, color: string): void {\r\n    ctx.strokeStyle = color;\r\n    ctx.fillStyle = color;\r\n    ctx.lineWidth = 2;\r\n\r\n    // Draw markers based on relationship type\r\n    switch (relationship.type) {\r\n      case 'one-to-one':\r\n        // Draw single line on both ends\r\n        this._drawSingleMarker(ctx, fromX, fromY, 'left');\r\n        this._drawSingleMarker(ctx, toX, toY, 'right');\r\n        break;\r\n\r\n      case 'one-to-many':\r\n        // Single line on 'from' side, crow's foot on 'to' side\r\n        this._drawSingleMarker(ctx, fromX, fromY, 'left');\r\n        this._drawCrowsFoot(ctx, toX, toY, 'right');\r\n        break;\r\n\r\n      case 'many-to-one':\r\n        // Crow's foot on 'from' side, single line on 'to' side\r\n        this._drawCrowsFoot(ctx, fromX, fromY, 'left');\r\n        this._drawSingleMarker(ctx, toX, toY, 'right');\r\n        break;\r\n\r\n      case 'many-to-many':\r\n        // Crow's foot on both sides\r\n        this._drawCrowsFoot(ctx, fromX, fromY, 'left');\r\n        this._drawCrowsFoot(ctx, toX, toY, 'right');\r\n        break;\r\n    }\r\n  }\r\n\r\n  private _drawSingleMarker(ctx: CanvasRenderingContext2D, x: number, y: number, side: string): void {\r\n    const lineLength = 10;\r\n    ctx.beginPath();\r\n    if (side === 'left') {\r\n      ctx.moveTo(x - lineLength, y - 5);\r\n      ctx.lineTo(x - lineLength, y + 5);\r\n    } else {\r\n      ctx.moveTo(x + lineLength, y - 5);\r\n      ctx.lineTo(x + lineLength, y + 5);\r\n    }\r\n    ctx.stroke();\r\n  }\r\n\r\n  private _drawCrowsFoot(ctx: CanvasRenderingContext2D, x: number, y: number, side: string): void {\r\n    const footLength = 12;\r\n    const footWidth = 8;\r\n\r\n    ctx.beginPath();\r\n    if (side === 'left') {\r\n      // Three lines forming crow's foot pointing left\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x - footLength, y - footWidth);\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x - footLength, y);\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x - footLength, y + footWidth);\r\n    } else {\r\n      // Three lines forming crow's foot pointing right\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x + footLength, y - footWidth);\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x + footLength, y);\r\n      ctx.moveTo(x, y);\r\n      ctx.lineTo(x + footLength, y + footWidth);\r\n    }\r\n    ctx.stroke();\r\n  }\r\n}\r\n","/**\r\n * Infrastructure: SQL Exporter\r\n *\r\n * Exports entities to SQL DDL\r\n */\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\nexport class SQLExporter {\r\n  export(entities: Entity[], relationships: Relationship[]): string {\r\n    let sql = '-- Generated SQL DDL\\n\\n';\r\n\r\n    for (const entity of entities) {\r\n      sql += `CREATE TABLE ${entity.name} (\\n`;\r\n\r\n      const fields = entity.fields.map(field => {\r\n        let line = `  ${field.name} `;\r\n\r\n        const typeMap: Record<string, string> = {\r\n          'string': 'VARCHAR(255)',\r\n          'int': 'INTEGER',\r\n          'bool': 'BOOLEAN',\r\n          'timestamp': 'TIMESTAMP',\r\n          'datetime': 'DATETIME',\r\n          'num': 'NUMERIC',\r\n          'double': 'DOUBLE PRECISION'\r\n        };\r\n        line += typeMap[field.type] || 'TEXT';\r\n\r\n        if (field.isPrimaryKey) line += ' PRIMARY KEY';\r\n        if (field.isRequired && !field.isPrimaryKey) line += ' NOT NULL';\r\n        if (field.isUnique) line += ' UNIQUE';\r\n        if (field.defaultValue) line += ` DEFAULT ${field.defaultValue}`;\r\n\r\n        return line;\r\n      });\r\n\r\n      sql += fields.join(',\\n') + '\\n);\\n\\n';\r\n    }\r\n\r\n    // Add foreign key constraints\r\n    for (const rel of relationships) {\r\n      sql += `ALTER TABLE ${rel.from.entity}\\n`;\r\n      sql += `  ADD CONSTRAINT fk_${rel.from.entity}_${rel.to.entity}\\n`;\r\n      sql += `  FOREIGN KEY (${rel.from.field})\\n`;\r\n      sql += `  REFERENCES ${rel.to.entity}(${rel.to.field});\\n\\n`;\r\n    }\r\n\r\n    return sql;\r\n  }\r\n}\r\n","/**\r\n * Infrastructure: TypeScript Exporter\r\n *\r\n * Exports entities to TypeScript interfaces\r\n */\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\n\r\nexport class TypeScriptExporter {\r\n  export(entities: Entity[], _relationships: Relationship[]): string {\r\n    let ts = '// Generated TypeScript Interfaces\\n\\n';\r\n\r\n    for (const entity of entities) {\r\n      ts += `export interface ${entity.displayName.replace(/\\s+/g, '')} {\\n`;\r\n\r\n      for (const field of entity.fields) {\r\n        const optional = !field.isRequired ? '?' : '';\r\n        const typeMap: Record<string, string> = {\r\n          'string': 'string',\r\n          'int': 'number',\r\n          'num': 'number',\r\n          'double': 'number',\r\n          'bool': 'boolean',\r\n          'timestamp': 'Date',\r\n          'datetime': 'Date'\r\n        };\r\n        const type = typeMap[field.type] || 'any';\r\n\r\n        if (field.enumValues && field.enumValues.length > 0) {\r\n          ts += `  ${field.name}${optional}: ${field.enumValues.map(v => `'${v}'`).join(' | ')};\\n`;\r\n        } else {\r\n          ts += `  ${field.name}${optional}: ${type};\\n`;\r\n        }\r\n      }\r\n\r\n      ts += '}\\n\\n';\r\n    }\r\n\r\n    return ts;\r\n  }\r\n}\r\n","/**\r\n * Infrastructure: JSON Exporter\r\n *\r\n * Exports entities to JSON schema\r\n */\r\nimport { Entity } from '../../domain/entities/Entity';\r\nimport { Relationship } from '../../domain/entities/Relationship';\r\nimport { entityToJSON, relationshipToJSON } from '../../data/models/utils';\r\n\r\nexport class JSONExporter {\r\n  export(entities: Entity[], relationships: Relationship[]): string {\r\n    const schema = {\r\n      entities: entities.map(e => entityToJSON(e)),\r\n      relationships: relationships.map(r => relationshipToJSON(r))\r\n    };\r\n\r\n    return JSON.stringify(schema, null, 2);\r\n  }\r\n}\r\n","/**\r\n * Presentation Controller: AppController\r\n *\r\n * Coordinates UI interactions with application services\r\n */\r\nimport { DiagramService } from '../../application/services/DiagramService';\r\nimport { MonacoEditorFactory } from '../factories/MonacoEditorFactory';\r\nimport { ParseDSLResult } from '../../application/use-cases/ParseDSLUseCase';\r\n\r\n// Declare global Lucide icons\r\ndeclare global {\r\n  interface Window {\r\n    lucide?: {\r\n      createIcons(): void;\r\n    };\r\n  }\r\n}\r\n\r\nexport class AppController {\r\n  private editor: any = null;\r\n\r\n  constructor(\r\n    private diagramService: DiagramService,\r\n    private editorFactory: MonacoEditorFactory\r\n  ) {}\r\n\r\n  async initialize(): Promise<void> {\r\n    await this._initializeEditor();\r\n    this._setupEventListeners();\r\n    this._initializeLucideIcons();\r\n    await this._onDSLChange();\r\n  }\r\n\r\n  private async _initializeEditor(): Promise<void> {\r\n    const defaultDSL = this._getDefaultDSL();\r\n    this.editor = await this.editorFactory.createEditor(defaultDSL);\r\n\r\n    this.editor.onDidChangeModelContent(() => {\r\n      this._onDSLChange();\r\n    });\r\n  }\r\n\r\n  private _setupEventListeners(): void {\r\n    // Toolbar buttons\r\n    document.getElementById('zoomInBtn')!.addEventListener('click', () => {\r\n      this.diagramService.zoomIn();\r\n      this._updateZoomLevel();\r\n    });\r\n\r\n    document.getElementById('zoomOutBtn')!.addEventListener('click', () => {\r\n      this.diagramService.zoomOut();\r\n      this._updateZoomLevel();\r\n    });\r\n\r\n    document.getElementById('fitBtn')!.addEventListener('click', () => {\r\n      this.diagramService.fitToScreen();\r\n      this._updateZoomLevel();\r\n    });\r\n\r\n    document.getElementById('autoLayoutBtn')!.addEventListener('click', () => {\r\n      this.diagramService.autoLayout();\r\n    });\r\n\r\n    // Editor buttons\r\n    document.getElementById('formatBtn')!.addEventListener('click', () => {\r\n      this._formatDSL();\r\n    });\r\n\r\n    document.getElementById('validateBtn')!.addEventListener('click', () => {\r\n      this._validateDSL();\r\n    });\r\n\r\n    // Header buttons\r\n    document.getElementById('exportBtn')!.addEventListener('click', () => {\r\n      this._exportCode();\r\n    });\r\n\r\n    document.getElementById('saveBtn')!.addEventListener('click', () => {\r\n      this._saveDSL();\r\n    });\r\n\r\n    document.getElementById('resetBtn')!.addEventListener('click', () => {\r\n      if (confirm('Reset to default DSL? This will clear your current work.')) {\r\n        this.editor.setValue(this._getDefaultDSL());\r\n      }\r\n    });\r\n\r\n    // Resize handle\r\n    this._setupResizeHandle();\r\n  }\r\n\r\n  private _setupResizeHandle(): void {\r\n    const resizeHandle = document.getElementById('resizeHandle')!;\r\n    const canvasArea = document.querySelector('.canvas-area') as HTMLElement;\r\n    const editorArea = document.querySelector('.editor-area') as HTMLElement;\r\n\r\n    let isResizing = false;\r\n\r\n    resizeHandle.addEventListener('mousedown', (e: MouseEvent) => {\r\n      isResizing = true;\r\n      document.body.style.cursor = 'ew-resize';\r\n      e.preventDefault();\r\n    });\r\n\r\n    document.addEventListener('mousemove', (e: MouseEvent) => {\r\n      if (!isResizing) return;\r\n\r\n      const containerWidth = (document.querySelector('.main-content') as HTMLElement).clientWidth;\r\n      const editorWidth = containerWidth - e.clientX;\r\n      const canvasWidth = e.clientX;\r\n\r\n      const editorPercent = (editorWidth / containerWidth) * 100;\r\n      const canvasPercent = (canvasWidth / containerWidth) * 100;\r\n\r\n      if (editorPercent >= 15 && editorPercent <= 50) {\r\n        canvasArea.style.flex = `0 0 ${canvasPercent}%`;\r\n        editorArea.style.flex = `0 0 ${editorPercent}%`;\r\n      }\r\n    });\r\n\r\n    document.addEventListener('mouseup', () => {\r\n      isResizing = false;\r\n      document.body.style.cursor = 'default';\r\n    });\r\n  }\r\n\r\n  private async _onDSLChange(): Promise<void> {\r\n    const dsl = this.editor.getValue();\r\n    const result = await this.diagramService.parseDSL(dsl);\r\n\r\n    this.diagramService.renderDiagram();\r\n    this._updateStatus(result);\r\n    this._updateInfo(result);\r\n    this._updateZoomLevel();\r\n  }\r\n\r\n  private _updateStatus(result: ParseDSLResult): void {\r\n    const statusIndicator = document.getElementById('statusIndicator')!;\r\n    const errorMessage = document.getElementById('errorMessage')!;\r\n\r\n    if (result.isValid) {\r\n      statusIndicator.className = 'status-ok';\r\n      statusIndicator.innerHTML = '<i data-lucide=\"check-circle\"></i> Valid';\r\n      errorMessage.textContent = '';\r\n    } else {\r\n      statusIndicator.className = 'status-error';\r\n      statusIndicator.innerHTML = '<i data-lucide=\"alert-circle\"></i> Error';\r\n      errorMessage.textContent = result.errors.map(e => e.message).join(', ');\r\n    }\r\n\r\n    this._initializeLucideIcons();\r\n  }\r\n\r\n  private _updateInfo(result: ParseDSLResult): void {\r\n    document.getElementById('entityCount')!.textContent =\r\n      `${result.entities.length} ${result.entities.length === 1 ? 'entity' : 'entities'}`;\r\n    document.getElementById('relationCount')!.textContent =\r\n      `${result.relationships.length} ${result.relationships.length === 1 ? 'relation' : 'relations'}`;\r\n  }\r\n\r\n  private _updateZoomLevel(): void {\r\n    const zoomLevel = this.diagramService.getZoomLevel();\r\n    document.getElementById('zoomLevel')!.textContent = `${zoomLevel}%`;\r\n  }\r\n\r\n  private _formatDSL(): void {\r\n    const dsl = this.editor.getValue();\r\n    const lines = dsl.split('\\n');\r\n    const formatted: string[] = [];\r\n    let indent = 0;\r\n\r\n    for (const line of lines) {\r\n      const trimmed = line.trim();\r\n      if (!trimmed) {\r\n        formatted.push('');\r\n        continue;\r\n      }\r\n\r\n      if (trimmed.includes('}')) indent--;\r\n      formatted.push('  '.repeat(Math.max(0, indent)) + trimmed);\r\n      if (trimmed.includes('{')) indent++;\r\n    }\r\n\r\n    this.editor.setValue(formatted.join('\\n'));\r\n  }\r\n\r\n  private async _validateDSL(): Promise<void> {\r\n    const dsl = this.editor.getValue();\r\n    const result = await this.diagramService.parseDSL(dsl);\r\n\r\n    if (result.isValid) {\r\n      alert('✓ DSL is valid!');\r\n    } else {\r\n      alert('✗ DSL has errors:\\n\\n' + result.errors.map(e => `Line ${e.line}: ${e.message}`).join('\\n'));\r\n    }\r\n  }\r\n\r\n  private _saveDSL(): void {\r\n    const dsl = this.editor.getValue();\r\n    const blob = new Blob([dsl], { type: 'text/plain' });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement('a');\r\n    a.href = url;\r\n    a.download = 'schema.dsl';\r\n    a.click();\r\n    URL.revokeObjectURL(url);\r\n  }\r\n\r\n  private _exportCode(): void {\r\n    const format = prompt(\r\n      'Export format:\\n' +\r\n      '1 - DSL (current format)\\n' +\r\n      '2 - JSON Schema\\n' +\r\n      '3 - SQL DDL\\n' +\r\n      '4 - TypeScript Interfaces\\n\\n' +\r\n      'Enter number (1-4):',\r\n      '1'\r\n    );\r\n\r\n    if (!format) return;\r\n\r\n    let exportContent = '';\r\n    let fileExtension = 'txt';\r\n\r\n    try {\r\n      switch (format) {\r\n        case '1':\r\n          exportContent = this.editor.getValue();\r\n          fileExtension = 'dsl';\r\n          break;\r\n        case '2':\r\n          exportContent = this.diagramService.exportCode('json');\r\n          fileExtension = 'json';\r\n          break;\r\n        case '3':\r\n          exportContent = this.diagramService.exportCode('sql');\r\n          fileExtension = 'sql';\r\n          break;\r\n        case '4':\r\n          exportContent = this.diagramService.exportCode('typescript');\r\n          fileExtension = 'ts';\r\n          break;\r\n        default:\r\n          alert('Invalid format');\r\n          return;\r\n      }\r\n\r\n      const blob = new Blob([exportContent], { type: 'text/plain' });\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement('a');\r\n      a.href = url;\r\n      a.download = `export.${fileExtension}`;\r\n      a.click();\r\n      URL.revokeObjectURL(url);\r\n    } catch (error) {\r\n      alert(`Export error: ${error instanceof Error ? error.message : 'Unknown error'}`);\r\n    }\r\n  }\r\n\r\n  private _initializeLucideIcons(): void {\r\n    if (window.lucide) {\r\n      window.lucide.createIcons();\r\n    }\r\n  }\r\n\r\n  private _getDefaultDSL(): string {\r\n    return `\r\n// Comprehensive Relationships Demo\r\n// This example demonstrates all relationship types and features\r\n\r\n// Users entity\r\nusers {\r\n    id uuid @pk\r\n    username string @unique @required\r\n    email string @unique @required\r\n    profileId uuid @fk\r\n}\r\n\r\n// Profiles entity (one-to-one with users)\r\nprofiles {\r\n    id uuid @pk\r\n    userId uuid @fk @unique\r\n    bio text\r\n    avatar string\r\n}\r\n\r\n// Teams entity\r\nteams {\r\n    id uuid @pk\r\n    name string @required\r\n    description text\r\n}\r\n\r\n// Posts entity\r\nposts {\r\n    id uuid @pk\r\n    authorId uuid @fk @required\r\n    title string @required\r\n    content text\r\n    status string @enum(fields: [draft, published, archived])\r\n}\r\n\r\n// Comments entity\r\ncomments {\r\n    id uuid @pk\r\n    postId uuid @fk @required\r\n    text text @required\r\n    createdAt timestamp @default(now)\r\n  userId uuid required\r\n}\r\n\r\n// Tags entity (for many-to-many with posts)\r\ntags {\r\n    id uuid @pk\r\n    userId uuid @fk @required\r\n    name string @unique @required\r\n}\r\n\r\n// Post-Tags junction table (many-to-many)\r\npost_tags {\r\n    id uuid @pk\r\n    postId uuid @fk @required\r\n    tagId uuid @fk @required\r\n}\r\nroles [icon: shield, color: orange] {\r\n\r\n  id uuid pk\r\n  name string unique required\r\n  description text\r\n}\r\npermissions [icon: key, color: green] {\r\n\r\n  id uuid pk\r\n  name string unique required\r\n  description text\r\n}\r\nuser_roles [icon: users, color: purple] {\r\n\r\n  id uuid pk\r\n  userId uuid required\r\n  roleId uuid required\r\n}\r\nrole_permissions [icon: lock, color: teal] {\r\n\r\n  id uuid pk\r\n  roleId uuid required\r\n  permissionId uuid required\r\n}\r\nprojects [icon: folder, color: blue] {\r\n\r\n  id uuid pk\r\n  name string required\r\n  description text\r\n  teamId uuid required\r\n  createdAt timestamp\r\n}\r\nmilestones [icon: flag, color: yellow] {\r\n\r\n  id uuid pk\r\n  projectId uuid required\r\n  name string required\r\n  dueDate date\r\n  status string\r\n}\r\nattachments [icon: paperclip, color: gray] {\r\n\r\n  id uuid pk\r\n  postId uuid required\r\n  filename string required\r\n  url string required\r\n  uploadedAt timestamp\r\n}\r\nnotifications [icon: bell, color: red] {\r\n\r\n  id uuid pk\r\n  userId uuid required\r\n  message string required\r\n  read boolean\r\n  createdAt timestamp\r\n}\r\nuser_projects [icon: users, color: pink] {\r\n\r\n  id uuid pk\r\n  userId uuid required\r\n  projectId uuid required\r\n}\r\n\r\n\r\n// ============================================\r\n// RELATIONSHIPS\r\n// ============================================\r\n\r\n// One-to-One: Users to Profiles\r\n// Each user has exactly one profile\r\nusers.profileId - profiles.id\r\n\r\n// Many-to-One: Posts to Users\r\n// Many posts belong to one author (user)\r\nposts.authorId > users.id\r\n\r\n// Many-to-One: Users to Teams\r\n// Many users belong to one team\r\nusers.id > teams.id\r\n\r\n// Many-to-One: Comments to Posts\r\n// Many comments belong to one post\r\ncomments.postId > posts.id\r\n\r\n// Many-to-One: Comments to Users\r\n// Many comments belong to one user\r\ntags.userId > users.id\r\n\r\n// Many-to-Many: Posts to Tags (through post_tags)\r\n// Posts can have many tags, tags can belong to many posts\r\npost_tags.postId > posts.id\r\npost_tags.tagId > tags.id\r\n\r\n// Alternative entity-level syntax (defaults to id fields):\r\n// users > teams\r\n// This is equivalent to: users.id > teams.id\r\nuser_roles.userId > users.id\r\nuser_roles.roleId > roles.id\r\nrole_permissions.roleId > roles.id\r\nrole_permissions.permissionId > permissions.id\r\nprojects.teamId > teams.id\r\nmilestones.projectId > projects.id\r\nattachments.postId > posts.id\r\nnotifications.userId > roles.id\r\nuser_projects.userId > users.id\r\nuser_projects.projectId > projects.id\r\nprojects.id < posts.authorId\r\ncomments.userId > users.id\r\n\r\n    `;\r\n  }\r\n}\r\n","/**\r\n * Presentation Factory: Monaco Editor Factory\r\n *\r\n * Creates and configures Monaco editor instances\r\n */\r\n\r\n// Declare global Monaco types\r\ndeclare global {\r\n  interface Window {\r\n    monaco: any;\r\n    require: {\r\n      (deps: string[], callback: (...args: any[]) => void): void;\r\n      (deps: string[], callback: (...args: any[]) => void, errback: (err: any) => void): void;\r\n      config(options: { paths: Record<string, string> }): void;\r\n    };\r\n  }\r\n}\r\n\r\nexport class MonacoEditorFactory {\r\n  async createEditor(initialValue: string): Promise<any> {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        window.require.config({\r\n          paths: {\r\n            vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'\r\n          }\r\n        });\r\n\r\n        window.require(['vs/editor/editor.main'], () => {\r\n          const monaco = window.monaco;\r\n\r\n          // Register custom language for DSL\r\n          monaco.languages.register({ id: 'dsl' });\r\n\r\n          // Define syntax highlighting\r\n          monaco.languages.setMonarchTokensProvider('dsl', {\r\n            tokenizer: {\r\n              root: [\r\n                [/\\/\\/.*$/, 'comment'],\r\n                [/@\\w+/, 'decorator'],\r\n                [/\\b(string|int|bool|timestamp|datetime|num|double)\\b/, 'type'],\r\n                [/\\b(true|false|now)\\b/, 'keyword'],\r\n                [/\\[([^\\]]+)\\]/, 'metadata'],\r\n                [/\\{|\\}/, 'delimiter.bracket'],\r\n                [/->/, 'operator'],\r\n              ]\r\n            }\r\n          });\r\n\r\n          // Define theme\r\n          monaco.editor.defineTheme('dsl-dark', {\r\n            base: 'vs-dark',\r\n            inherit: true,\r\n            rules: [\r\n              { token: 'comment', foreground: '6A9955' },\r\n              { token: 'decorator', foreground: 'DCDCAA', fontStyle: 'bold' },\r\n              { token: 'type', foreground: '4EC9B0' },\r\n              { token: 'keyword', foreground: 'C586C0' },\r\n              { token: 'metadata', foreground: '9CDCFE' },\r\n              { token: 'operator', foreground: 'D4D4D4' },\r\n            ],\r\n            colors: {\r\n              'editor.background': '#0f172a',\r\n              'editor.lineHighlightBackground': '#1e293b',\r\n            }\r\n          });\r\n\r\n          // Create editor\r\n          const editor = monaco.editor.create(document.getElementById('dslEditor')!, {\r\n            value: initialValue,\r\n            language: 'dsl',\r\n            theme: 'dsl-dark',\r\n            automaticLayout: true,\r\n            fontSize: 14,\r\n            minimap: { enabled: false },\r\n            scrollBeyondLastLine: false,\r\n            lineNumbers: 'on',\r\n            folding: true,\r\n            wordWrap: 'on',\r\n          });\r\n\r\n          resolve(editor);\r\n        }, (error: any) => {\r\n          console.error('Failed to load Monaco Editor:', error);\r\n          reject(error);\r\n        });\r\n      } catch (error) {\r\n        console.error('Error configuring Monaco Editor:', error);\r\n        reject(error);\r\n      }\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Main Entry Point\r\n *\r\n * Bootstraps the application with dependency injection\r\n */\r\n\r\n// Application\r\nimport { ParseDSLUseCase } from './application/use-cases/ParseDSLUseCase';\r\nimport { RenderDiagramUseCase } from './application/use-cases/RenderDiagramUseCase';\r\nimport { ExportCodeUseCase } from './application/use-cases/ExportCodeUseCase';\r\nimport { DiagramService } from './application/services/DiagramService';\r\n\r\n// Infrastructure\r\nimport { DSLParserAdapter } from './infrastructure/parsers/DSLParserAdapter';\r\nimport { CanvasRendererAdapter } from './infrastructure/renderers/CanvasRendererAdapter';\r\nimport { SQLExporter } from './infrastructure/exporters/SQLExporter';\r\nimport { TypeScriptExporter } from './infrastructure/exporters/TypeScriptExporter';\r\nimport { JSONExporter } from './infrastructure/exporters/JSONExporter';\r\n\r\n// Presentation\r\nimport { AppController } from './presentation/controllers/AppController';\r\nimport { MonacoEditorFactory } from './presentation/factories/MonacoEditorFactory';\r\n\r\n/**\r\n * Application Composition Root\r\n *\r\n * This is where we wire up all dependencies following Clean Architecture principles:\r\n * - Domain entities are pure business logic with no dependencies\r\n * - Application use cases depend only on domain entities and repository interfaces\r\n * - Infrastructure adapters implement repository interfaces\r\n * - Presentation controllers depend on application services\r\n */\r\nclass Application {\r\n  private container: {\r\n    diagramRepository?: DSLParserAdapter;\r\n    renderer?: CanvasRendererAdapter;\r\n    exporters?: Record<string, any>;\r\n    parseDSLUseCase?: ParseDSLUseCase;\r\n    renderDiagramUseCase?: RenderDiagramUseCase;\r\n    exportCodeUseCase?: ExportCodeUseCase;\r\n    diagramService?: DiagramService;\r\n    editorFactory?: MonacoEditorFactory;\r\n    appController?: AppController;\r\n  };\r\n\r\n  constructor() {\r\n    this.container = this._setupDependencyContainer();\r\n  }\r\n\r\n  private _setupDependencyContainer() {\r\n    const container: any = {};\r\n\r\n    // Infrastructure Layer - Repository Implementations\r\n    container.diagramRepository = new DSLParserAdapter();\r\n\r\n    // Infrastructure Layer - Renderer\r\n    const canvas = document.getElementById('diagramCanvas') as HTMLCanvasElement;\r\n    if (!canvas) {\r\n      throw new Error('Canvas element not found');\r\n    }\r\n    container.renderer = new CanvasRendererAdapter(canvas);\r\n\r\n    // Infrastructure Layer - Exporters\r\n    container.exporters = {\r\n      'sql': new SQLExporter(),\r\n      'typescript': new TypeScriptExporter(),\r\n      'json': new JSONExporter()\r\n    };\r\n\r\n    // Application Layer - Use Cases\r\n    container.parseDSLUseCase = new ParseDSLUseCase(container.diagramRepository);\r\n    container.renderDiagramUseCase = new RenderDiagramUseCase(container.renderer);\r\n    container.exportCodeUseCase = new ExportCodeUseCase(container.exporters);\r\n\r\n    // Application Layer - Service\r\n    container.diagramService = new DiagramService(\r\n      container.parseDSLUseCase,\r\n      container.renderDiagramUseCase,\r\n      container.exportCodeUseCase\r\n    );\r\n\r\n    // Presentation Layer - Factories\r\n    container.editorFactory = new MonacoEditorFactory();\r\n\r\n    // Presentation Layer - Controller\r\n    container.appController = new AppController(\r\n      container.diagramService,\r\n      container.editorFactory\r\n    );\r\n\r\n    return container;\r\n  }\r\n\r\n  async start(): Promise<void> {\r\n    try {\r\n      console.log('🚀 Starting ERP Visual Designer with Clean Architecture...');\r\n      await this.container.appController!.initialize();\r\n      console.log('✅ Application initialized successfully');\r\n    } catch (error) {\r\n      console.error('❌ Failed to initialize application:', error);\r\n      alert('Failed to initialize application. Please check the console for details.');\r\n    }\r\n  }\r\n}\r\n\r\n// Bootstrap the application when DOM is ready\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  const app = new Application();\r\n  app.start();\r\n});\r\n\r\n// Export for debugging purposes\r\n(window as any).__app = Application;\r\n"],"names":["getRelationshipCardinality","relationship","validateField","field","validateRelationship","validateEntity","entity","fieldValidation","reorderEntityFields","newOrder","orderedFields","fieldMap","f","fieldName","addFieldToEntity","fieldToJSON","relationshipToJSON","entityToJSON","ParseDSLUseCase","diagramRepository","dslText","result","entityErrors","validation","relationErrors","allErrors","error","RenderDiagramUseCase","renderer","entities","relationships","ExportCodeUseCase","exporters","format","exporter","DiagramService","parseDSLUseCase","renderDiagramUseCase","exportCodeUseCase","Entity","props","Field","Relationship","DSLParserAdapter","errors","lines","line","commentIndex","currentEntity","i","entityMatch","entityName","metadataStr","metadata","data","pairs","pair","key","value","s","match","fieldType","decoratorsStr","decorators","isPrimaryKey","d","isForeignKey","isUnique","isRequired","defaultDecorator","defaultValue","enumDecorator","enumValues","regex","name","argsStr","args","params","v","relationshipRegex","fromEntity","fromField","connector","toEntity","toField","type","word","Position","other","dx","dy","ConnectionBasedLayoutEngine2","relations","rel","left","right","connections","allEntities","processed","entityOrder","remaining","entitiesOnRight","chosenEntity","maxConnections","conn","toRemove","idx","clusters","clusterLeft","clusterRight","layers","findLayerIndex","removeFromLayers","layer","canAddToLayer","layerIdx","existing","moveEntityToRightOfParent","parentEntity","childEntity","parentLayer","iteration","cluster","anchor","anchorLocation","e","newLayers","getChildren","parent","children","descendants","root","visited","queue","current","child","desc","leftEntity","placed","leftLayers","maxLeftLayer","rightPlacedLayer","levelMap","currentLevel","descendantsSorted","a","b","levelA","levelB","pivots","anchorLayerIdx","rightPlaced","reorderedLayers","lastLayerIdx","lastLayer","orderedLast","currentLayer","nextLayer","entityToTarget","target","entityToAllTargets","targets","ts","orderedLayer","entityMaxTargetPos","maxPos","t","sortedEntities","posA","posB","indexA","indexB","clustersByTarget","targetEntity","layersMap","layerOf","maxLayer","LayoutPositioner","headerHeight","fieldHeight","config","positions","entityMap","layerIndex","layerNodes","totalHeight","entityHeights","height","currentY","x","FieldOrderingAlgorithm","orderedLayers","entityVerticalPosition","layerEntities","position","pass","fieldConnectionPositions","connectedEntityPositions","targetEntityName","targetEntityPos","fieldOrder","targetPositions","avgPos","sum","pos","originalOrder","MagneticAlignmentOptimizer","CanvasRendererAdapter","canvas","ctx","width","centerX","centerY","newZoom","zoomChange","minX","minY","maxX","maxY","contentWidth","contentHeight","padding","zoomX","zoomY","finalLayers","names","rect","dpr","isMouseDown","worldPos","clickedEntity","hoveredEntity","stopDragging","mouseX","mouseY","zoomDelta","screenX","screenY","y","cols","spacing","index","row","col","fieldY","fieldText","entityPos","fieldIndex","fromPos","toPos","fromFieldY","toFieldY","fromCenterX","toCenterX","fromX","fromY","toX","toY","lineColor","midX","midY","labelX","labelY","color","side","SQLExporter","sql","fields","TypeScriptExporter","_relationships","optional","JSONExporter","schema","r","AppController","diagramService","editorFactory","defaultDSL","resizeHandle","canvasArea","editorArea","isResizing","containerWidth","editorWidth","canvasWidth","editorPercent","canvasPercent","dsl","statusIndicator","errorMessage","zoomLevel","formatted","indent","trimmed","blob","url","exportContent","fileExtension","MonacoEditorFactory","initialValue","resolve","reject","monaco","editor","Application","container"],"mappings":"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"}